# Dockerfile để test cài đặt .deb package
# Sử dụng Ubuntu 24.04 LTS (tương thích với amd64)
FROM ubuntu:24.04

# Tránh tương tác trong quá trình cài đặt
ENV DEBIAN_FRONTEND=noninteractive

# Thêm Ubuntu 22.04 (jammy) repository để cài FFmpeg libraries version 58/57/5
# vì package .deb yêu cầu các version này
RUN echo "deb http://archive.ubuntu.com/ubuntu jammy main universe" > /etc/apt/sources.list.d/jammy.list && \
    echo "deb http://archive.ubuntu.com/ubuntu jammy-updates main universe" >> /etc/apt/sources.list.d/jammy.list && \
    printf "Package: *\nPin: release n=noble\nPin-Priority: 600\n\nPackage: libavcodec58 libavcodec57 libavformat58 libavformat57 libswscale5 libswscale4\nPin: release n=jammy\nPin-Priority: 1000\n" > /etc/apt/preferences.d/jammy-ffmpeg

# Cài đặt các dependencies cần thiết cho runtime
RUN apt-get update && apt-get install -y \
    # Dependencies cơ bản
    libc6 \
    libstdc++6 \
    libgcc-s1 \
    adduser \
    systemd \
    systemd-sysv \
    # OpenCV runtime
    libopencv-dev \
    # GStreamer và plugins
    libgstreamer1.0-0 \
    libgstreamer-plugins-base1.0-0 \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    gstreamer1.0-tools \
    gstreamer1.0-x \
    gstreamer1.0-alsa \
    gstreamer1.0-gl \
    gstreamer1.0-gtk3 \
    gstreamer1.0-rtsp \
    gstreamer1.0-qt5 \
    gstreamer1.0-pulseaudio \
    libgstrtspserver-1.0-0 \
    python3-gst-1.0 \
    # TurboJPEG (Ubuntu 24.04 dùng libturbojpeg)
    libturbojpeg \
    # Mosquitto
    mosquitto \
    mosquitto-clients \
    libmosquitto1 \
    # SSL (Ubuntu 24.04 dùng libssl3t64)
    libssl3t64 \
    # JSON (runtime package - có thể được bundle trong .deb)
    libjsoncpp25 \
    # cURL (Ubuntu 24.04 dùng libcurl4t64)
    libcurl4t64 \
    # FFmpeg libraries (package .deb yêu cầu version 58/57/5 từ Ubuntu 22.04)
    libavcodec58 \
    libavformat58 \
    libswscale5 \
    # Utilities
    curl \
    wget \
    dpkg \
    && rm -rf /var/lib/apt/lists/*

# Copy file .deb vào container
COPY edge-ai-api-with-sdk-2026.0.1.21-amd64.deb /tmp/

# Cài đặt package
# Trong Docker build, systemd không có sẵn nên cần bỏ qua lỗi post-installation
# Strategy: Unpack package, verify files, skip configure để tránh systemd errors
RUN dpkg --force-depends --unpack /tmp/edge-ai-api-with-sdk-2026.0.1.21-amd64.deb && \
    # Kiểm tra files ngay sau khi unpack (trước khi configure)
    if [ ! -f /usr/local/bin/edge_ai_api ] || [ ! -f /usr/local/bin/edge_ai_worker ]; then \
        echo "ERROR: Package files not found after unpack"; \
        exit 1; \
    fi && \
    echo "✓ Files extracted successfully" && \
    # Fix dependencies nhưng không configure lại (để tránh systemd errors)
    apt-get update && \
    apt-get install -f -y --no-install-recommends && \
    # Kiểm tra lại files sau khi fix dependencies
    if [ ! -f /usr/local/bin/edge_ai_api ] || [ ! -f /usr/local/bin/edge_ai_worker ]; then \
        echo "ERROR: Package files missing after dependency fix"; \
        exit 1; \
    fi && \
    # Mark package as installed manually (bypass configure)
    echo "edge-ai-api hold" | dpkg --set-selections || true && \
    echo "✓ Package installed successfully (systemd configure step skipped)"

# Expose port cho API
EXPOSE 8080

# Tạo entrypoint script để test
RUN echo '#!/bin/bash\n\
echo "=== Edge AI API Test Container ==="\n\
echo "Package đã được cài đặt tại:"\n\
ls -la /usr/local/bin/edge_ai_api 2>/dev/null || echo "Executable không tìm thấy"\n\
echo ""\n\
echo "Service files:"\n\
ls -la /etc/systemd/system/edge-ai-api.service 2>/dev/null || echo "Service file không tìm thấy"\n\
echo ""\n\
echo "Config files:"\n\
ls -la /opt/edge_ai_api/ 2>/dev/null || echo "Config directory không tìm thấy"\n\
echo ""\n\
echo "Để test service, chạy:"\n\
echo "  systemctl start edge-ai-api"\n\
echo "  systemctl status edge-ai-api"\n\
echo "  curl http://localhost:8080/v1/core/health"\n\
echo ""\n\
echo "Hoặc chạy trực tiếp:"\n\
echo "  /usr/local/bin/edge_ai_api"\n\
echo ""\n\
bash\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

# Sử dụng systemd (cần cho service)
# Note: systemd trong Docker cần --privileged flag
ENTRYPOINT ["/entrypoint.sh"]

