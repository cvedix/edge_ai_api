<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge AI API - Scalar Documentation</title>
    <script>
        // Global state to track Scalar loading
        window.scalarLoadState = {
            attempted: false,
            loading: false,
            loaded: false,
            error: null,
            promise: null
        };
        
        // Function to load script dynamically
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (typeof ScalarApiReference !== 'undefined') {
                    resolve();
                    return;
                }
                
                // Check if script tag already exists
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    // Script tag exists, wait for it to load
                    if (existingScript.onload) {
                        existingScript.onload();
                    } else {
                        const checkLoaded = setInterval(() => {
                            if (typeof ScalarApiReference !== 'undefined') {
                                clearInterval(checkLoaded);
                                resolve();
                            }
                        }, 100);
                        
                        existingScript.addEventListener('load', () => {
                            clearInterval(checkLoaded);
                            resolve();
                        });
                        existingScript.addEventListener('error', () => {
                            clearInterval(checkLoaded);
                            reject(new Error(`Script tag exists but failed to load`));
                        });
                    }
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.crossOrigin = 'anonymous';
                
                script.onload = function() {
                    console.log('Scalar script loaded successfully from:', src);
                    // Script loaded, but global might not be available immediately
                    // Resolve immediately - we'll check for global later
                    resolve();
                };
                
                script.onerror = function(error) {
                    console.warn('Failed to load Scalar from:', src, error);
                    reject(new Error(`Failed to load script from ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Load Scalar with fallback CDNs
        async function loadScalarScript() {
            // If already loaded, return immediately
            if (typeof ScalarApiReference !== 'undefined') {
                window.scalarLoadState.loaded = true;
                return;
            }
            
            // If already loading, return the existing promise
            if (window.scalarLoadState.loading && window.scalarLoadState.promise) {
                return window.scalarLoadState.promise;
            }
            
            // If already attempted and failed, throw error
            if (window.scalarLoadState.attempted && window.scalarLoadState.error) {
                throw window.scalarLoadState.error;
            }
            
            // Start loading
            window.scalarLoadState.loading = true;
            window.scalarLoadState.attempted = true;
            
            const loadPromise = (async () => {
                const cdnUrls = [
                    'https://cdn.jsdelivr.net/npm/@scalar/api-reference@1.24.0/dist/browser/standalone.js',
                    'https://unpkg.com/@scalar/api-reference@1.24.0/dist/browser/standalone.js'
                ];
                
                for (const url of cdnUrls) {
                    try {
                        await loadScript(url);
                        // Script loaded successfully - global might be available later
                        console.log('Scalar script loaded from:', url);
                        window.scalarLoadState.loading = false;
                        // Don't check for global here - it might not be available immediately
                        // The initialization code will handle checking for the global
                        return;
                    } catch (error) {
                        console.warn('Failed to load from', url, error);
                        continue; // Try next CDN
                    }
                }
                
                // All CDNs failed
                const error = new Error('Failed to load Scalar from all CDN sources');
                window.scalarLoadState.error = error;
                window.scalarLoadState.loading = false;
                throw error;
            })();
            
            window.scalarLoadState.promise = loadPromise;
            return loadPromise;
        }
        
        // Start loading immediately (non-blocking)
        loadScalarScript().catch(error => {
            console.warn('Initial Scalar load attempt failed (will retry on init):', error);
        });
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .language-selector label {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        .language-selector select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }
        .language-selector select:hover {
            border-color: #999;
        }
        .language-selector select:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }
        #api-reference {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            width: 100%;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        /* Minimal CSS - only hide very specific skeleton elements if they exist */
        /* Removed aggressive hiding rules that were blocking content */
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <label for="language-select">Language / Ngôn ngữ:</label>
        <select id="language-select">
            <option value="en">English</option>
            <option value="vi">Tiếng Việt</option>
        </select>
    </div>
    
    <div id="api-reference"></div>
    
    <!-- Server will inject configuration here -->
    <!-- If placeholders are not replaced, the code will use fallback defaults -->
    <script id="server-config" type="application/json">
{
    "baseUrl": "{{BASE_URL}}",
    "version": "{{VERSION}}",
    "fallbackUrl": "{{FALLBACK_URL}}"
}
    </script>
    
    <script>
        // Clean up JSON string - fix double quotes issue
        function cleanJsonString(jsonString) {
            // Fix double quotes in property values: ""value"" -> "value"
            // This handles cases like: "baseUrl": ""http://localhost:61486"" 
            // and converts to: "baseUrl": "http://localhost:61486"
            
            // Match pattern: "key": ""value"" where value can contain any characters except unescaped quotes
            // We'll match the colon and whitespace, then fix the double quotes around the value
            return jsonString.replace(/(":\s*)""([^"]*(?:\\.[^"]*)*)""/g, '$1"$2"');
        }
        
        // Get configuration from server-injected script tag
        function getServerConfig() {
            const configScript = document.getElementById('server-config');
            if (configScript && configScript.textContent) {
                try {
                    // Clean up the text content (remove any whitespace issues)
                    let configText = configScript.textContent.trim();
                    
                    // Check if placeholders are still present before parsing
                    if (configText.includes('{{') && configText.includes('}}')) {
                        console.log('Server config contains unreplaced placeholders, using fallback');
                        // Placeholders not replaced, use fallback
                        return getFallbackConfig();
                    }
                    
                    // Fix double quotes issue (e.g., ""value"" -> "value")
                    configText = cleanJsonString(configText);
                    
                    // Try to parse the JSON
                    const config = JSON.parse(configText);
                    
                    // Validate that we got valid config values
                    if (config && typeof config === 'object') {
                        // Check if placeholders were replaced (double check)
                        if (config.baseUrl && typeof config.baseUrl === 'string' && !config.baseUrl.includes('{{')) {
                            return config;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to parse server config:', e);
                    console.warn('Config content:', configScript.textContent);
                    // Try to extract values manually as last resort
                    try {
                        const manualConfig = extractConfigManually(configScript.textContent);
                        if (manualConfig) {
                            console.log('Successfully extracted config manually');
                            return manualConfig;
                        }
                    } catch (manualError) {
                        console.warn('Manual extraction also failed:', manualError);
                    }
                }
            }
            // Fallback to defaults
            return getFallbackConfig();
        }
        
        // Manual extraction as fallback when JSON parsing fails
        function extractConfigManually(text) {
            const baseUrlMatch = text.match(/"baseUrl":\s*""?([^"]+)""?/);
            const versionMatch = text.match(/"version":\s*""?([^"]+)""?/);
            const fallbackUrlMatch = text.match(/"fallbackUrl":\s*""?([^"]+)""?/);
            
            if (baseUrlMatch && baseUrlMatch[1]) {
                const baseUrl = baseUrlMatch[1].replace(/^"|"$/g, ''); // Remove surrounding quotes
                const version = versionMatch && versionMatch[1] ? versionMatch[1].replace(/^"|"$/g, '') : 'v1';
                const fallbackUrl = fallbackUrlMatch && fallbackUrlMatch[1] 
                    ? fallbackUrlMatch[1].replace(/^"|"$/g, '') 
                    : baseUrl + '/' + version + '/openapi.yaml';
                
                return {
                    baseUrl: baseUrl,
                    version: version,
                    fallbackUrl: fallbackUrl
                };
            }
            return null;
        }
        
        // Helper function for fallback config
        function getFallbackConfig() {
            return {
                baseUrl: window.location.origin,
                version: 'v1',
                fallbackUrl: window.location.origin + '/v1/openapi.yaml'
            };
        }
        
        // Lấy ngôn ngữ từ URL parameter hoặc localStorage
        function getLanguage() {
            const urlParams = new URLSearchParams(window.location.search);
            const langFromUrl = urlParams.get('lang');
            if (langFromUrl && (langFromUrl === 'en' || langFromUrl === 'vi')) {
                return langFromUrl;
            }
            const langFromStorage = localStorage.getItem('api-docs-language');
            if (langFromStorage && (langFromStorage === 'en' || langFromStorage === 'vi')) {
                return langFromStorage;
            }
            return 'en'; // Default to English
        }

        // Lưu ngôn ngữ đã chọn
        function saveLanguage(lang) {
            localStorage.setItem('api-docs-language', lang);
            const url = new URL(window.location);
            url.searchParams.set('lang', lang);
            window.history.replaceState({}, '', url);
        }

        // Khởi tạo Scalar với ngôn ngữ đã chọn
        async function initializeScalar(language) {
            let config;
            try {
                config = getServerConfig();
            } catch (error) {
                console.error('Error getting server config:', error);
                config = getFallbackConfig();
            }
            
            const baseUrl = config.baseUrl || window.location.origin;
            const versionStr = config.version || 'v1';
            const configFallbackUrl = config.fallbackUrl || (window.location.origin + '/v1/openapi.yaml');
            
            // Build spec URL - try with language first, fallback to default
            let specUrl;
            let fallbackUrl;
            if (versionStr && versionStr !== '' && versionStr !== '""' && versionStr !== 'null') {
                specUrl = baseUrl + '/' + versionStr + '/openapi/' + language + '/openapi.yaml';
                fallbackUrl = baseUrl + '/' + versionStr + '/openapi.yaml';
            } else {
                specUrl = baseUrl + '/openapi/' + language + '/openapi.yaml';
                fallbackUrl = baseUrl + '/openapi.yaml';
            }
            
            // Use config fallback URL if our computed fallback is not available
            // (config fallback might be more reliable)
            if (!fallbackUrl || fallbackUrl === configFallbackUrl) {
                // Keep our computed fallback
            } else {
                // Prefer config fallback if it's different and might be more reliable
                console.log('Using config fallback URL as alternative:', configFallbackUrl);
            }
            
            console.log('Initializing Scalar with spec URL:', specUrl);
            console.log('Fallback URL:', fallbackUrl);

            // Get the api-reference element
            const apiRef = document.getElementById('api-reference');
            if (!apiRef) {
                console.error('api-reference element not found');
                return Promise.reject(new Error('api-reference element not found'));
            }

            // Clear old content
            apiRef.innerHTML = '';
            
            // Set data-spec-url attribute for Scalar auto-initialization
            // This is the simplest and most reliable way
            apiRef.setAttribute('data-spec-url', specUrl);
            
            // Wait for Scalar to be available, then let it auto-initialize
            return waitForScalarAndInitialize();
            
            async function waitForScalarAndInitialize() {
                // Wait for Scalar script to load
                let retries = 0;
                const maxRetries = 50; // 5 seconds
                while (retries < maxRetries) {
                    if (typeof ScalarApiReference !== 'undefined') {
                        console.log('ScalarApiReference found, allowing auto-initialization');
                        // Scalar will auto-initialize from data-spec-url attribute
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                // If Scalar didn't load, try manual initialization
                console.warn('ScalarApiReference not found after waiting, trying manual init');
                return initScalar();
            }

            // Helper function to check if Scalar is available - check all possible ways
            function isScalarAvailable() {
                // Check various possible global names
                if (typeof ScalarApiReference !== 'undefined') return true;
                if (typeof window.ScalarApiReference !== 'undefined') return true;
                if (window.ScalarApiReference) return true;
                if (typeof Scalar !== 'undefined') return true;
                if (typeof window.Scalar !== 'undefined') return true;
                if (window.Scalar) return true;
                
                // Check if script has loaded by looking for any Scalar-related globals
                for (let key in window) {
                    if (key.includes('Scalar') || key.includes('scalar')) {
                        console.log('Found Scalar-related global:', key);
                        return true;
                    }
                }
                
                return false;
            }
            
            // Helper function to get ScalarApiReference - try all possible ways
            function getScalarApiReference() {
                // Try ScalarApiReference first
                if (typeof ScalarApiReference !== 'undefined') {
                    return ScalarApiReference;
                }
                if (typeof window.ScalarApiReference !== 'undefined') {
                    return window.ScalarApiReference;
                }
                if (window.ScalarApiReference) {
                    return window.ScalarApiReference;
                }
                
                // Try Scalar
                if (typeof Scalar !== 'undefined') {
                    return Scalar;
                }
                if (typeof window.Scalar !== 'undefined') {
                    return window.Scalar;
                }
                if (window.Scalar) {
                    return window.Scalar;
                }
                
                // Search for any Scalar-related global
                for (let key in window) {
                    if (key.includes('Scalar') || key.includes('scalar')) {
                        const obj = window[key];
                        if (obj && (obj.default || typeof obj === 'function')) {
                            console.log('Using Scalar global:', key);
                            return obj;
                        }
                    }
                }
                
                return null;
            }
            
            // Đợi Scalar script load xong rồi mới khởi tạo
            async function initScalar() {
                try {
                    // First, check which URL is available
                    let finalUrl = specUrl;
                    try {
                        console.log('Checking if language-specific URL exists:', specUrl);
                        const response = await fetch(specUrl, { method: 'HEAD' });
                        if (!response.ok) {
                            throw new Error(`URL returned ${response.status}`);
                        }
                        console.log('✅ Language-specific URL exists, using it');
                        finalUrl = specUrl;
                    } catch (urlError) {
                        console.warn('Language-specific URL not found, trying fallback:', fallbackUrl);
                        try {
                            const fallbackResponse = await fetch(fallbackUrl, { method: 'HEAD' });
                            if (fallbackResponse.ok) {
                                console.log('✅ Fallback URL exists, using it');
                                finalUrl = fallbackUrl;
                            } else {
                                throw new Error(`Fallback URL returned ${fallbackResponse.status}`);
                            }
                        } catch (fallbackError) {
                            console.error('Both URLs failed, using language-specific URL anyway:', fallbackError);
                            finalUrl = specUrl; // Use original URL, let Scalar handle the error
                        }
                    }
                    
                    // Create configuration with the final URL (use new format - not deprecated)
                    const configuration = {
                        url: finalUrl,  // New format - not deprecated
                        theme: 'default',
                        layout: 'modern'
                    };
                    console.log('Final URL for Scalar:', finalUrl);
                    console.log('Configuration:', configuration);
                    
                    // Ensure Scalar script is loaded
                    if (!isScalarAvailable()) {
                        console.log('Scalar not loaded yet, attempting to load...');
                        try {
                            await loadScalarScript();
                        } catch (loadError) {
                            console.error('Failed to load Scalar script:', loadError);
                            // Try using data-configuration method as fallback
                            console.log('Trying data-configuration method...');
                            // Configuration will be created later, use default for now
                            useDataConfigurationMethod();
                            return;
                        }
                    }
                    
                    // Wait a bit more to ensure it's fully initialized
                    let retries = 0;
                    const maxRetries = 100; // 10 seconds
                    while (!isScalarAvailable() && retries < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retries++;
                    }
                    
                    const ScalarRef = getScalarApiReference();
                    if (!ScalarRef) {
                        console.warn('ScalarApiReference not found, trying data-configuration method...');
                        // Configuration will be created later, use default for now
                        useDataConfigurationMethod();
                        return;
                    }
                    
                    // Log the structure to understand what we have
                    console.log('ScalarRef type:', typeof ScalarRef);
                    console.log('ScalarRef:', ScalarRef);
                    console.log('ScalarRef.default:', ScalarRef.default);
                    console.log('ScalarRef keys:', Object.keys(ScalarRef || {}));
                    
                    // Scalar đã load, khởi tạo trực tiếp
                    try {
                        console.log('Initializing Scalar with configuration:', configuration);
                        
                        // Try multiple ways to initialize
                        let scalarInstance = null;
                        
                        // Method 1: ScalarRef.default
                        if (ScalarRef.default && typeof ScalarRef.default === 'function') {
                            scalarInstance = ScalarRef.default;
                            console.log('Using ScalarRef.default');
                        }
                        // Method 2: ScalarRef itself
                        else if (typeof ScalarRef === 'function') {
                            scalarInstance = ScalarRef;
                            console.log('Using ScalarRef directly');
                        }
                        // Method 3: ScalarRef.ApiReference
                        else if (ScalarRef.ApiReference && typeof ScalarRef.ApiReference === 'function') {
                            scalarInstance = ScalarRef.ApiReference;
                            console.log('Using ScalarRef.ApiReference');
                        }
                        // Method 4: ScalarRef.create
                        else if (ScalarRef.create && typeof ScalarRef.create === 'function') {
                            scalarInstance = ScalarRef.create;
                            console.log('Using ScalarRef.create');
                        }
                        // Method 5: Check for any function property
                        else {
                            for (let key in ScalarRef) {
                                if (typeof ScalarRef[key] === 'function') {
                                    console.log('Found function property:', key);
                                    scalarInstance = ScalarRef[key];
                                    break;
                                }
                            }
                        }
                        
                        if (scalarInstance && typeof scalarInstance === 'function') {
                            const apiRef = document.getElementById('api-reference');
                            if (!apiRef) {
                                console.error('api-reference element not found');
                                return;
                            }
                            
                            // Try multiple ways to call createApiReference
                            let initialized = false;
                            
                            // Method 1: With target selector (try sync and async)
                            try {
                                console.log('Method 1: Calling with target selector');
                                const result1 = scalarInstance({
                                    ...configuration,
                                    target: '#api-reference'
                                });
                                console.log('Method 1 result:', result1);
                                console.log('Method 1 result keys:', result1 ? Object.keys(result1) : 'null');
                                
                                // Check if result has an app that needs mounting
                                if (result1 && result1.app) {
                                    console.log('Found app in result, checking if it needs mounting...');
                                    console.log('app type:', typeof result1.app);
                                    console.log('app keys:', result1.app ? Object.keys(result1.app) : 'null');
                                    
                                    // Try mounting the app if it has a mount method
                                    if (result1.app && typeof result1.app.mount === 'function') {
                                        console.log('Mounting app to #api-reference...');
                                        try {
                                            result1.app.mount('#api-reference');
                                            console.log('✅ App mounted successfully to #api-reference');
                                            initialized = true;
                                        } catch (mountError) {
                                            console.warn('Mount to #api-reference failed:', mountError);
                                            // Try mounting to element directly
                                            try {
                                                result1.app.mount(apiRef);
                                                console.log('✅ App mounted successfully to element');
                                                initialized = true;
                                            } catch (mountError2) {
                                                console.warn('Mount to element also failed:', mountError2);
                                                // Still mark as initialized, maybe it will work
                                                initialized = true;
                                            }
                                        }
                                    } else {
                                        console.log('App does not have mount method or app is null');
                                        console.log('Result structure:', {
                                            hasApp: !!result1.app,
                                            appType: typeof result1.app,
                                            appKeys: result1.app ? Object.keys(result1.app) : null
                                        });
                                        initialized = true;
                                    }
                                }
                                
                                // Check if it's a promise
                                if (!initialized && result1 && typeof result1.then === 'function') {
                                    console.log('Method 1 returned a promise, awaiting...');
                                    result1.then((resolvedResult) => {
                                        console.log('Method 1 promise resolved:', resolvedResult);
                                        // Check if resolved result has app
                                        if (resolvedResult && resolvedResult.app && typeof resolvedResult.app.mount === 'function') {
                                            try {
                                                resolvedResult.app.mount('#api-reference');
                                                console.log('✅ App mounted from promise');
                                            } catch (mountErr) {
                                                console.warn('Mount from promise failed, trying element:', mountErr);
                                                try {
                                                    resolvedResult.app.mount(apiRef);
                                                    console.log('✅ App mounted to element from promise');
                                                } catch (mountErr2) {
                                                    console.warn('Mount to element from promise also failed:', mountErr2);
                                                }
                                            }
                                        }
                                        initialized = true;
                                    }).catch(err => {
                                        console.warn('Method 1 promise rejected:', err);
                                    });
                                } else if (!initialized) {
                                    initialized = true;
                                }
                            } catch (e1) {
                                console.warn('Method 1 failed:', e1.message);
                            }
                            
                            // Method 2: With element directly (if createApiReference) - try different formats
                            if (!initialized && scalarInstance === ScalarRef.createApiReference) {
                                // Helper function to mount app if present
                                const tryMountApp = (result, methodName) => {
                                    if (result && result.app && typeof result.app.mount === 'function') {
                                        console.log(`Mounting app from ${methodName}...`);
                                        try {
                                            result.app.mount('#api-reference');
                                            console.log(`${methodName} app mounted successfully`);
                                            initialized = true;
                                            return true;
                                        } catch (mountErr) {
                                            console.warn(`${methodName} mount failed, trying element:`, mountErr);
                                            try {
                                                result.app.mount(apiRef);
                                                console.log(`${methodName} app mounted to element successfully`);
                                                initialized = true;
                                                return true;
                                            } catch (mountErr2) {
                                                console.warn(`${methodName} mount to element also failed:`, mountErr2);
                                                return false;
                                            }
                                        }
                                    }
                                    return false;
                                };
                                
                                // Try 2a: element + config object
                                try {
                                    console.log('Method 2a: createApiReference(element, config)');
                                    const result2a = ScalarRef.createApiReference(apiRef, configuration);
                                    console.log('Method 2a result:', result2a);
                                    
                                    // Check if it's a promise
                                    if (result2a && typeof result2a.then === 'function') {
                                        console.log('Method 2a returned a promise, awaiting...');
                                        result2a.then((resolvedResult) => {
                                            console.log('Method 2a promise resolved:', resolvedResult);
                                            if (!tryMountApp(resolvedResult, 'Method 2a')) {
                                                initialized = true;
                                            }
                                        }).catch(err => {
                                            console.warn('Method 2a promise rejected:', err);
                                        });
                                    } else {
                                        if (!tryMountApp(result2a, 'Method 2a')) {
                                            initialized = true;
                                        }
                                    }
                                } catch (e2a) {
                                    console.warn('Method 2a failed:', e2a.message);
                                    
                                    // Try 2b: element + spec URL string
                                    try {
                                        console.log('Method 2b: createApiReference(element, specUrl)');
                                        const result2b = ScalarRef.createApiReference(apiRef, configuration.url);
                                        console.log('Method 2b result:', result2b);
                                        
                                        if (result2b && typeof result2b.then === 'function') {
                                            result2b.then((resolvedResult) => {
                                                console.log('Method 2b promise resolved:', resolvedResult);
                                                if (!tryMountApp(resolvedResult, 'Method 2b')) {
                                                    initialized = true;
                                                }
                                            }).catch(err => {
                                                console.warn('Method 2b promise rejected:', err);
                                            });
                                        } else {
                                            if (!tryMountApp(result2b, 'Method 2b')) {
                                                initialized = true;
                                            }
                                        }
                                    } catch (e2b) {
                                        console.warn('Method 2b failed:', e2b.message);
                                        
                                        // Try 2c: just element (maybe it reads from data-configuration)
                                        try {
                                            console.log('Method 2c: createApiReference(element)');
                                            const result2c = ScalarRef.createApiReference(apiRef);
                                            console.log('Method 2c result:', result2c);
                                            
                                            if (result2c && typeof result2c.then === 'function') {
                                                result2c.then((resolvedResult) => {
                                                    console.log('Method 2c promise resolved:', resolvedResult);
                                                    if (!tryMountApp(resolvedResult, 'Method 2c')) {
                                                        initialized = true;
                                                    }
                                                }).catch(err => {
                                                    console.warn('Method 2c promise rejected:', err);
                                                });
                                            } else {
                                                if (!tryMountApp(result2c, 'Method 2c')) {
                                                    initialized = true;
                                                }
                                            }
                                        } catch (e2c) {
                                            console.warn('Method 2c failed:', e2c.message);
                                        }
                                    }
                                }
                            }
                            
                            // Method 3: With element and target
                            if (!initialized) {
                                try {
                                    console.log('Method 3: Calling with element in config');
                                    const result3 = scalarInstance({
                                        ...configuration,
                                        target: apiRef
                                    });
                                    console.log('Method 3 result:', result3);
                                    initialized = true;
                                } catch (e3) {
                                    console.warn('Method 3 failed:', e3.message);
                                }
                            }
                            
                            // Wait a bit for async operations
                            setTimeout(async () => {
                                if (initialized) {
                                    // Check if element was populated after a delay
                                    const apiRefCheck = document.getElementById('api-reference');
                                    if (apiRefCheck) {
                                        console.log('Checking api-reference after initialization...');
                                        console.log('api-reference innerHTML length:', apiRefCheck.innerHTML.length);
                                        console.log('api-reference children count:', apiRefCheck.children.length);
                                        console.log('api-reference computed style display:', window.getComputedStyle(apiRefCheck).display);
                                        console.log('api-reference first 500 chars:', apiRefCheck.innerHTML.substring(0, 500));
                                        
                                        // Only hide actual skeleton loaders - be very careful not to hide real content
                                        const hideSkeletons = () => {
                                            // Only target elements that are clearly skeletons and empty
                                            const skeletons = apiRefCheck.querySelectorAll('[data-skeleton="true"], [class*="skeleton"]:empty, [aria-label*="loading"][aria-busy="true"]:empty');
                                            skeletons.forEach(el => {
                                                // Double check it's actually a skeleton and not content
                                                if (el && el.parentElement && el.children.length === 0 && el.textContent.trim() === '') {
                                                    const hasContent = el.querySelector('*');
                                                    if (!hasContent) {
                                                        el.style.display = 'none';
                                                    }
                                                }
                                            });
                                        };
                                        
                                        // Only run after content is loaded, and only once
                                        if (apiRefCheck.innerHTML.length > 100) {
                                            setTimeout(hideSkeletons, 2000);
                                        }
                                        
                                        if (apiRefCheck.innerHTML.length === 0 || 
                                            (apiRefCheck.children.length === 0 && apiRefCheck.innerHTML.trim().length < 50)) {
                                            console.warn('api-reference is still empty after 3 seconds');
                                            console.warn('Trying data-configuration method as fallback...');
                                            useDataConfigurationMethod();
                                        } else {
                                            console.log('✅ Scalar content rendered successfully!');
                                            
                                            // Force visibility - check if content is hidden
                                            const computedStyle = window.getComputedStyle(apiRefCheck);
                                            console.log('Element visibility:', {
                                                display: computedStyle.display,
                                                visibility: computedStyle.visibility,
                                                opacity: computedStyle.opacity,
                                                height: computedStyle.height,
                                                width: computedStyle.width
                                            });
                                            
                                            // Ensure element is visible
                                            if (computedStyle.display === 'none') {
                                                console.warn('Element is hidden, forcing display...');
                                                apiRefCheck.style.display = 'block';
                                            }
                                            if (computedStyle.visibility === 'hidden') {
                                                console.warn('Element visibility is hidden, forcing visible...');
                                                apiRefCheck.style.visibility = 'visible';
                                            }
                                            if (parseFloat(computedStyle.opacity) === 0) {
                                                console.warn('Element opacity is 0, forcing opacity...');
                                                apiRefCheck.style.opacity = '1';
                                            }
                                            
                                            // Force CSS to ensure visibility
                                            apiRefCheck.style.setProperty('display', 'block', 'important');
                                            apiRefCheck.style.setProperty('visibility', 'visible', 'important');
                                            apiRefCheck.style.setProperty('opacity', '1', 'important');
                                            apiRefCheck.style.setProperty('position', 'relative', 'important');
                                            apiRefCheck.style.setProperty('z-index', '1', 'important');
                                            
                                            // Check if children are visible
                                            const firstChild = apiRefCheck.firstElementChild;
                                            if (firstChild) {
                                                const childStyle = window.getComputedStyle(firstChild);
                                                console.log('First child visibility:', {
                                                    display: childStyle.display,
                                                    visibility: childStyle.visibility,
                                                    opacity: childStyle.opacity,
                                                    position: childStyle.position,
                                                    zIndex: childStyle.zIndex
                                                });
                                                
                                                // Force child visibility
                                                firstChild.style.setProperty('display', 'block', 'important');
                                                firstChild.style.setProperty('visibility', 'visible', 'important');
                                                firstChild.style.setProperty('opacity', '1', 'important');
                                                
                                                // Check if element is in viewport
                                                const rect = apiRefCheck.getBoundingClientRect();
                                                console.log('Element position in viewport:', {
                                                    top: rect.top,
                                                    left: rect.left,
                                                    bottom: rect.bottom,
                                                    right: rect.right,
                                                    width: rect.width,
                                                    height: rect.height,
                                                    inViewport: rect.top >= 0 && rect.left >= 0 && 
                                                               rect.bottom <= window.innerHeight && 
                                                               rect.right <= window.innerWidth
                                                });
                                                
                                                // Scroll to element if not in viewport
                                                if (rect.top < 0 || rect.top > window.innerHeight) {
                                                    console.log('Element not in viewport, scrolling to it...');
                                                    apiRefCheck.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                }
                                            }
                                            
                                            // Check for any overlaying elements
                                            const elementsAtPoint = document.elementsFromPoint(
                                                window.innerWidth / 2, 
                                                window.innerHeight / 2
                                            );
                                            console.log('Elements at center of viewport:', elementsAtPoint.slice(0, 5).map(el => ({
                                                tag: el.tagName,
                                                id: el.id,
                                                class: el.className,
                                                zIndex: window.getComputedStyle(el).zIndex
                                            })));
                                        }
                                    }
                                } else {
                                    console.error('All initialization methods failed');
                                    useDataConfigurationMethod();
                                }
                            }, 3000); // Wait 3 seconds for async operations
                        } else {
                            console.error('No valid Scalar function found, structure:', ScalarRef);
                            // Try data-configuration method instead
                            useDataConfigurationMethod();
                            return;
                        }
                    } catch (error) {
                        console.error('Error initializing Scalar:', error);
                        // Fallback: thử dùng fallbackUrl với format mới
                        try {
                            const fallbackConfig = {
                                url: fallbackUrl,  // New format - not deprecated
                                theme: 'default',
                                layout: 'modern'
                            };
                            console.log('Trying fallback URL with new format:', fallbackUrl);
                            const ScalarRef2 = getScalarApiReference();
                            if (!ScalarRef2) {
                                throw new Error('ScalarApiReference not available');
                            }
                            
                            // Try the same methods as above
                            let scalarInstance = ScalarRef2.default || ScalarRef2;
                            if (ScalarRef2.ApiReference && typeof ScalarRef2.ApiReference === 'function') {
                                scalarInstance = ScalarRef2.ApiReference;
                            }
                            
                            if (typeof scalarInstance === 'function') {
                                const fallbackResult = scalarInstance({
                                    ...fallbackConfig,
                                    target: '#api-reference'
                                });
                                
                                // Try mounting app if present
                                if (fallbackResult && fallbackResult.app && typeof fallbackResult.app.mount === 'function') {
                                    try {
                                        fallbackResult.app.mount('#api-reference');
                                        console.log('✅ Fallback URL app mounted successfully');
                                    } catch (mountErr) {
                                        console.warn('Fallback mount failed:', mountErr);
                                    }
                                }
                                console.log('Fallback URL initialization succeeded');
                            } else {
                                throw new Error('Scalar instance is not a function');
                            }
                        } catch (fallbackError) {
                            console.error('Fallback also failed:', fallbackError);
                            // Last resort: use data-configuration
                            console.log('Trying data-configuration method as last resort...');
                            useDataConfigurationMethod(configuration);
                        }
                    }
                } catch (error) {
                    console.error('Error in initScalar:', error);
                    // Last resort: use data-configuration
                    console.log('Trying data-configuration method as last resort...');
                    useDataConfigurationMethod(configuration);
                }
            }
            
            // Use data-configuration method (like the C++ code does)
            function useDataConfigurationMethod(configToUse = null) {
                console.log('Using data-configuration method to initialize Scalar');
                const apiRef = document.getElementById('api-reference');
                if (apiRef) {
                    // Use provided config or create a default one
                    const config = configToUse || {
                        url: fallbackUrl || specUrl,
                        theme: 'default',
                        layout: 'modern'
                    };
                    
                    // Don't clear content if it already has content (might be from previous mount)
                    if (apiRef.innerHTML.trim().length < 100) {
                        apiRef.innerHTML = '';
                    } else {
                        console.log('api-reference already has content, keeping it');
                    }
                    
                    // Remove any existing config script to prevent auto-initialization conflicts
                    const existingConfig = document.getElementById('api-reference-config');
                    if (existingConfig) {
                        existingConfig.remove();
                    }
                    
                    // Remove data-configuration from div to prevent auto-initialization
                    apiRef.removeAttribute('data-configuration');
                    
                    // Don't use data-configuration method if we already have content
                    // Instead, try manual initialization
                    if (apiRef.innerHTML.trim().length > 100) {
                        console.log('Content already exists, skipping data-configuration method');
                        return;
                    }
                    
                    // Try method 1: Set data-configuration on the div itself
                    apiRef.setAttribute('data-configuration', JSON.stringify(config));
                    console.log('Set data-configuration on #api-reference div');
                    
                    // Try method 2: Also create a script element with data-configuration (like C++ code)
                    const configScript = document.createElement('script');
                    configScript.id = 'api-reference-config';
                    configScript.setAttribute('data-configuration', JSON.stringify(config));
                    document.body.appendChild(configScript);
                    console.log('Created data-configuration script element in body');
                    
                    // Scalar standalone.js should auto-initialize when it sees this
                    console.log('Waiting for Scalar to auto-initialize...');
                    
                    // Wait a bit and check if Scalar initialized
                    setTimeout(() => {
                        // Check if api-reference has content (Scalar initialized)
                        const hasContent = apiRef.children.length > 0 && 
                                         !apiRef.querySelector('#api-reference-config') &&
                                         apiRef.innerHTML.trim().length > 0;
                        
                        if (!hasContent) {
                            console.warn('Scalar did not auto-initialize from data-configuration');
                            console.log('api-reference content:', apiRef.innerHTML.substring(0, 200));
                            
                            // Try to find Scalar and initialize manually
                            const ScalarRef = getScalarApiReference();
                            if (ScalarRef) {
                                console.log('Found ScalarRef, trying manual initialization with all methods...');
                                try {
                                    // Try all possible initialization methods
                                    const methods = [
                                        () => ScalarRef.default,
                                        () => ScalarRef,
                                        () => ScalarRef.ApiReference,
                                        () => ScalarRef.create,
                                        () => {
                                            for (let key in ScalarRef) {
                                                if (typeof ScalarRef[key] === 'function') {
                                                    return ScalarRef[key];
                                                }
                                            }
                                            return null;
                                        }
                                    ];
                                    
                                    let initialized = false;
                                    for (let getMethod of methods) {
                                        try {
                                            const method = getMethod();
                                            if (method && typeof method === 'function') {
                                                console.log('Trying initialization method:', getMethod.toString().substring(0, 50));
                                                const result = method({
                                                    ...config,
                                                    target: '#api-reference'
                                                });
                                                console.log('Method result:', result);
                                                
                                                // Check if result has app that needs mounting
                                                if (result && result.app && typeof result.app.mount === 'function') {
                                                    console.log('Mounting app from result...');
                                                    try {
                                                        result.app.mount('#api-reference');
                                                        console.log('App mounted successfully!');
                                                        initialized = true;
                                                        break;
                                                    } catch (mountErr) {
                                                        console.warn('Mount failed, trying element:', mountErr);
                                                        try {
                                                            result.app.mount(apiRef);
                                                            console.log('App mounted to element successfully!');
                                                            initialized = true;
                                                            break;
                                                        } catch (mountErr2) {
                                                            console.warn('Mount to element also failed:', mountErr2);
                                                        }
                                                    }
                                                } else {
                                                    console.log('No app to mount, assuming auto-initialized');
                                                    initialized = true;
                                                    break;
                                                }
                                            }
                                        } catch (e) {
                                            console.warn('Method failed:', e.message);
                                        }
                                    }
                                    
                                    if (!initialized) {
                                        throw new Error('All initialization methods failed');
                                    }
                                } catch (e) {
                                    console.error('Manual initialization failed:', e);
                                    showScalarInitError(e);
                                }
                            } else {
                                console.error('ScalarApiReference still not available');
                                showScalarLoadError();
                            }
                        } else {
                            console.log('Scalar auto-initialized successfully from data-configuration');
                        }
                    }, 3000); // Wait 3 seconds for auto-initialization
                }
            }
            
            // Helper function to show load error
            function showScalarLoadError() {
                const apiRef = document.getElementById('api-reference');
                if (apiRef) {
                    apiRef.innerHTML = 
                        '<div style="padding: 40px; text-align: center; max-width: 600px; margin: 50px auto;">' +
                        '<h2 style="color: #d32f2f;">Error loading API documentation</h2>' +
                        '<p style="color: #666; margin: 20px 0;">Scalar script failed to load from all CDN sources. This could be due to:</p>' +
                        '<ul style="text-align: left; display: inline-block; color: #666;">' +
                        '<li>Network connectivity issues</li>' +
                        '<li>CDN blocking or unavailable (jsdelivr.net, unpkg.com)</li>' +
                        '<li>Browser tracking prevention blocking the CDN</li>' +
                        '<li>Firewall/proxy restrictions</li>' +
                        '</ul>' +
                        '<p style="color: #666; margin-top: 20px;">Please check your internet connection, disable tracking prevention for this site, or try refreshing the page.</p>' +
                        '<button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Page</button>' +
                        '</div>';
                }
            }
            
            // Helper function to show init error
            function showScalarInitError(error) {
                const apiRef = document.getElementById('api-reference');
                if (apiRef) {
                    apiRef.innerHTML = 
                        '<div style="padding: 20px; text-align: center;">' +
                        '<h2>Error loading API documentation</h2>' +
                        '<p>Failed to initialize Scalar. Error: ' + (error?.message || 'Unknown error') + '</p>' +
                        '<p>Please check browser console for details.</p>' +
                        '</div>';
                }
            }
        }

        // Xử lý thay đổi ngôn ngữ
        async function handleLanguageChange() {
            const select = document.getElementById('language-select');
            const selectedLang = select.value;
            saveLanguage(selectedLang);
            await initializeScalar(selectedLang).catch(err => {
                console.error('Failed to reinitialize Scalar with new language:', err);
            });
        }

        // Khởi tạo
        function init() {
            const currentLang = getLanguage();
            const select = document.getElementById('language-select');
            if (select) {
                select.value = currentLang;
                select.addEventListener('change', handleLanguageChange);
            }
            
            // Set initial data-spec-url immediately so Scalar can auto-initialize when it loads
            const apiRef = document.getElementById('api-reference');
            if (apiRef) {
                const baseUrl = window.location.origin;
                const version = 'v1';
                const specUrl = baseUrl + '/' + version + '/openapi/' + currentLang + '/openapi.yaml';
                apiRef.setAttribute('data-spec-url', specUrl);
                console.log('Set initial data-spec-url:', specUrl);
            }
            
            // Also call initializeScalar to handle language switching
            // Đợi window load xong (bao gồm cả external scripts)
            if (document.readyState === 'complete') {
                // Page already fully loaded
                setTimeout(function() {
                    initializeScalar(currentLang).catch(err => {
                        console.error('Failed to initialize Scalar:', err);
                    });
                }, 500);
            } else {
                // Wait for window load event (fires after all resources loaded)
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        initializeScalar(currentLang).catch(err => {
                            console.error('Failed to initialize Scalar:', err);
                        });
                    }, 500);
                });
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM đã sẵn sàng
            init();
        }
    </script>
</body>
</html>
