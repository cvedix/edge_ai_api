<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge AI API - Scalar Documentation</title>
    <script>
        // Global state to track Scalar loading
        window.scalarLoadState = {
            attempted: false,
            loading: false,
            loaded: false,
            error: null,
            promise: null
        };
        
        // Global reference to Scalar instance for cleanup
        window.scalarInstance = null;
        
        // Function to load script dynamically
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (typeof ScalarApiReference !== 'undefined') {
                    resolve();
                    return;
                }
                
                // Check if script tag already exists
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    // Script tag exists, wait for it to load
                    if (existingScript.onload) {
                        existingScript.onload();
                    } else {
                        const checkLoaded = setInterval(() => {
                            if (typeof ScalarApiReference !== 'undefined') {
                                clearInterval(checkLoaded);
                                resolve();
                            }
                        }, 100);
                        
                        existingScript.addEventListener('load', () => {
                            clearInterval(checkLoaded);
                            resolve();
                        });
                        existingScript.addEventListener('error', () => {
                            clearInterval(checkLoaded);
                            reject(new Error(`Script tag exists but failed to load`));
                        });
                    }
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.crossOrigin = 'anonymous';
                
                script.onload = function() {
                    console.log('Scalar script loaded successfully from:', src);
                    // Script loaded, but global might not be available immediately
                    // Resolve immediately - we'll check for global later
                    resolve();
                };
                
                script.onerror = function(error) {
                    console.warn('Failed to load Scalar from:', src, error);
                    reject(new Error(`Failed to load script from ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Load Scalar with fallback CDNs
        async function loadScalarScript() {
            // If already loaded, return immediately
            if (typeof ScalarApiReference !== 'undefined') {
                window.scalarLoadState.loaded = true;
                return;
            }
            
            // If already loading, return the existing promise
            if (window.scalarLoadState.loading && window.scalarLoadState.promise) {
                return window.scalarLoadState.promise;
            }
            
            // If already attempted and failed, throw error
            if (window.scalarLoadState.attempted && window.scalarLoadState.error) {
                throw window.scalarLoadState.error;
            }
            
            // Start loading
            window.scalarLoadState.loading = true;
            window.scalarLoadState.attempted = true;
            
            const loadPromise = (async () => {
                const cdnUrls = [
                    'https://cdn.jsdelivr.net/npm/@scalar/api-reference@1.24.0/dist/browser/standalone.js',
                    'https://unpkg.com/@scalar/api-reference@1.24.0/dist/browser/standalone.js'
                ];
                
                for (const url of cdnUrls) {
                    try {
                        await loadScript(url);
                        // Script loaded successfully - global might be available later
                        console.log('Scalar script loaded from:', url);
                        window.scalarLoadState.loading = false;
                        // Don't check for global here - it might not be available immediately
                        // The initialization code will handle checking for the global
                        return;
                    } catch (error) {
                        console.warn('Failed to load from', url, error);
                        continue; // Try next CDN
                    }
                }
                
                // All CDNs failed
                const error = new Error('Failed to load Scalar from all CDN sources');
                window.scalarLoadState.error = error;
                window.scalarLoadState.loading = false;
                throw error;
            })();
            
            window.scalarLoadState.promise = loadPromise;
            return loadPromise;
        }
        
        // Set initial data-spec-url BEFORE loading Scalar script
        // This ensures Scalar can auto-initialize when it loads
        function setInitialSpecUrl() {
            const apiRef = document.getElementById('api-reference');
            console.log('[Scalar] setInitialSpecUrl - apiRef:', apiRef);
            if (apiRef) {
                // Check if data-spec-url already set by server
                const existingUrl = apiRef.getAttribute('data-spec-url');
                console.log('[Scalar] setInitialSpecUrl - existing data-spec-url:', existingUrl);
                
                // Get language from URL or default to 'en'
                const urlParams = new URLSearchParams(window.location.search);
                const lang = urlParams.get('lang') || localStorage.getItem('api-docs-language') || 'en';
                const baseUrl = window.location.origin;
                const version = 'v1';
                const specUrl = baseUrl + '/' + version + '/openapi/' + lang + '/openapi.yaml';
                
                console.log('[Scalar] setInitialSpecUrl - computed specUrl:', specUrl);
                console.log('[Scalar] setInitialSpecUrl - language:', lang);
                
                // Only set if not already set or if different
                if (!existingUrl || existingUrl !== specUrl) {
                    apiRef.setAttribute('data-spec-url', specUrl);
                    console.log('[Scalar] setInitialSpecUrl - Set data-spec-url to:', specUrl);
                } else {
                    console.log('[Scalar] setInitialSpecUrl - data-spec-url already correct:', existingUrl);
                }
                return true; // Element found and URL set
            }
            return false; // Element not found
        }
        
        // Try to set URL immediately if DOM is ready
        if (document.readyState === 'loading') {
            // DOM is still loading, wait for DOMContentLoaded
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[Scalar] DOMContentLoaded fired');
                if (setInitialSpecUrl()) {
                    // Element found and URL set, now load script
                    console.log('[Scalar] Starting to load Scalar script after DOMContentLoaded');
                    loadScalarScript().catch(error => {
                        console.warn('Initial Scalar load attempt failed (will retry on init):', error);
                    });
                } else {
                    console.error('[Scalar] Element #api-reference not found in DOMContentLoaded!');
                }
            });
        } else {
            // DOM is already ready
            console.log('[Scalar] DOM already ready, setting URL immediately');
            if (setInitialSpecUrl()) {
                // Element found and URL set, now load script
                console.log('[Scalar] Starting to load Scalar script (DOM already ready)');
                loadScalarScript().catch(error => {
                    console.warn('Initial Scalar load attempt failed (will retry on init):', error);
                });
            } else {
                console.error('[Scalar] Element #api-reference not found! Waiting for DOMContentLoaded...');
                // Wait a bit and try again
                setTimeout(function() {
                    if (setInitialSpecUrl()) {
                        console.log('[Scalar] Element found after delay, loading script');
                        loadScalarScript().catch(error => {
                            console.warn('Initial Scalar load attempt failed (will retry on init):', error);
                        });
                    }
                }, 100);
            }
        }
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .language-selector label {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        .language-selector select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }
        .language-selector select:hover {
            border-color: #999;
        }
        .language-selector select:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }
        #api-reference {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            width: 100%;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        /* Minimal CSS - only hide very specific skeleton elements if they exist */
        /* Removed aggressive hiding rules that were blocking content */
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* ============================================
           JSON Display Enhancement Styles
           ============================================ */
        
        /* Container cho JSON response với controls */
        .json-display-wrapper {
            position: relative;
            margin: 12px 0;
        }
        
        /* Controls bar cho JSON blocks */
        .json-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            font-size: 12px;
        }
        
        /* Nút Copy JSON */
        .json-copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            color: #374151;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .json-copy-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            color: #111827;
        }
        
        .json-copy-btn:active {
            transform: scale(0.98);
        }
        
        .json-copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .json-copy-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }
        
        /* Toggle wrap button */
        .json-wrap-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            color: #374151;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .json-wrap-toggle:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        
        .json-wrap-toggle.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        /* Cải thiện hiển thị <pre><code> chứa JSON */
        /* Target các pre code blocks trong Scalar response */
        .scalar-api-reference pre code,
        pre code.hljs,
        pre code[class*="hljs"],
        pre code[class*="language-json"],
        .response-body pre code,
        .response-body pre code.hljs {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace !important;
            font-size: 13px !important;
            line-height: 1.7 !important;
            color: #24292e !important;
            background: transparent !important;
            padding: 0 !important;
            display: block !important;
            white-space: pre !important;
            word-wrap: normal !important;
            overflow-x: auto !important;
            tab-size: 2 !important;
        }
        
        /* Container cho pre code với line numbers */
        .json-with-lines {
            position: relative;
            display: flex;
            background: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 0 0 6px 6px;
            overflow: hidden;
            width: 100%;
            min-width: 0; /* Cho phép container shrink */
        }
        
        /* Line numbers column */
        .json-line-numbers {
            flex-shrink: 0;
            padding: 16px 12px 16px 16px;
            background: #f1f3f5;
            border-right: 1px solid #e1e4e8;
            color: #6e7681;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.7;
            text-align: right;
            user-select: none;
            min-width: 50px;
        }
        
        /* Code content area */
        .json-code-content {
            flex: 1;
            overflow: auto;
            padding: 16px;
            position: relative;
            min-width: 0; /* Cho phép flex item shrink */
            width: 100%;
        }
        
        /* Pre element styling */
        .json-code-content pre {
            margin: 0 !important;
            padding: 0 !important;
            background: transparent !important;
            overflow: visible !important;
            width: 100%;
            max-width: 100%;
        }
        
        /* Code element styling - đảm bảo hiển thị đầy đủ */
        .json-code-content pre code,
        .json-code-content pre code.hljs {
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
            overflow: visible !important;
            word-break: normal !important;
        }
        
        /* Wrap mode - cho phép wrap dòng */
        .json-display-wrapper.wrap-mode .json-code-content pre code,
        .json-display-wrapper.wrap-mode .json-code-content pre code.hljs {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
            overflow-wrap: break-word !important;
        }
        
        /* Đảm bảo wrapper không bị giới hạn width */
        .json-display-wrapper {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Scrollbar styling cho JSON container */
        .json-code-content::-webkit-scrollbar,
        .json-display-wrapper pre::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        .json-code-content::-webkit-scrollbar-track,
        .json-display-wrapper pre::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        .json-code-content::-webkit-scrollbar-thumb,
        .json-display-wrapper pre::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 5px;
        }
        
        .json-code-content::-webkit-scrollbar-thumb:hover,
        .json-display-wrapper pre::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Giữ nguyên syntax highlighting của highlight.js */
        .json-code-content .hljs-keyword,
        .json-code-content code .hljs-keyword {
            color: #d73a49 !important;
        }
        
        .json-code-content .hljs-string,
        .json-code-content code .hljs-string {
            color: #032f62 !important;
        }
        
        .json-code-content .hljs-number,
        .json-code-content code .hljs-number {
            color: #005cc5 !important;
        }
        
        .json-code-content .hljs-literal,
        .json-code-content code .hljs-literal {
            color: #e36209 !important;
        }
        
        .json-code-content .hljs-attr,
        .json-code-content code .hljs-attr {
            color: #6f42c1 !important;
            font-weight: 500 !important;
        }
        
        /* Responsive: ẩn line numbers trên màn hình nhỏ */
        @media (max-width: 768px) {
            .json-line-numbers {
                display: none;
            }
            .json-code-content {
                padding-left: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <label for="language-select">Language / Ngôn ngữ:</label>
        <select id="language-select">
            <option value="en">English</option>
            <option value="vi">Tiếng Việt</option>
        </select>
    </div>
    
    <div id="api-reference" data-spec-url="{{INITIAL_SPEC_URL}}"></div>
    
    <!-- Server will inject configuration here -->
    <!-- If placeholders are not replaced, the code will use fallback defaults -->
    <script id="server-config" type="application/json">
{
    "baseUrl": "{{BASE_URL}}",
    "version": "{{VERSION}}",
    "fallbackUrl": "{{FALLBACK_URL}}"
}
    </script>
    
    <script>
        // Clean up JSON string - fix double quotes issue
        function cleanJsonString(jsonString) {
            // Fix double quotes in property values: ""value"" -> "value"
            // This handles cases like: "baseUrl": ""http://localhost:61486"" 
            // and converts to: "baseUrl": "http://localhost:61486"
            
            // Match pattern: "key": ""value"" where value can contain any characters except unescaped quotes
            // We'll match the colon and whitespace, then fix the double quotes around the value
            return jsonString.replace(/(":\s*)""([^"]*(?:\\.[^"]*)*)""/g, '$1"$2"');
        }
        
        // Get configuration from server-injected script tag
        function getServerConfig() {
            const configScript = document.getElementById('server-config');
            if (configScript && configScript.textContent) {
                try {
                    // Clean up the text content (remove any whitespace issues)
                    let configText = configScript.textContent.trim();
                    
                    // Check if placeholders are still present before parsing
                    if (configText.includes('{{') && configText.includes('}}')) {
                        console.log('Server config contains unreplaced placeholders, using fallback');
                        // Placeholders not replaced, use fallback
                        return getFallbackConfig();
                    }
                    
                    // Fix double quotes issue (e.g., ""value"" -> "value")
                    configText = cleanJsonString(configText);
                    
                    // Try to parse the JSON
                    const config = JSON.parse(configText);
                    
                    // Validate that we got valid config values
                    if (config && typeof config === 'object') {
                        // Check if placeholders were replaced (double check)
                        if (config.baseUrl && typeof config.baseUrl === 'string' && !config.baseUrl.includes('{{')) {
                            return config;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to parse server config:', e);
                    console.warn('Config content:', configScript.textContent);
                    // Try to extract values manually as last resort
                    try {
                        const manualConfig = extractConfigManually(configScript.textContent);
                        if (manualConfig) {
                            console.log('Successfully extracted config manually');
                            return manualConfig;
                        }
                    } catch (manualError) {
                        console.warn('Manual extraction also failed:', manualError);
                    }
                }
            }
            // Fallback to defaults
            return getFallbackConfig();
        }
        
        // Manual extraction as fallback when JSON parsing fails
        function extractConfigManually(text) {
            const baseUrlMatch = text.match(/"baseUrl":\s*""?([^"]+)""?/);
            const versionMatch = text.match(/"version":\s*""?([^"]+)""?/);
            const fallbackUrlMatch = text.match(/"fallbackUrl":\s*""?([^"]+)""?/);
            
            if (baseUrlMatch && baseUrlMatch[1]) {
                const baseUrl = baseUrlMatch[1].replace(/^"|"$/g, ''); // Remove surrounding quotes
                const version = versionMatch && versionMatch[1] ? versionMatch[1].replace(/^"|"$/g, '') : 'v1';
                const fallbackUrl = fallbackUrlMatch && fallbackUrlMatch[1] 
                    ? fallbackUrlMatch[1].replace(/^"|"$/g, '') 
                    : baseUrl + '/' + version + '/openapi.yaml';
                
                return {
                    baseUrl: baseUrl,
                    version: version,
                    fallbackUrl: fallbackUrl
                };
            }
            return null;
        }
        
        // Helper function for fallback config
        function getFallbackConfig() {
            return {
                baseUrl: window.location.origin,
                version: 'v1',
                fallbackUrl: window.location.origin + '/v1/openapi.yaml'
            };
        }
        
        // Lấy ngôn ngữ từ URL parameter hoặc localStorage
        function getLanguage() {
            const urlParams = new URLSearchParams(window.location.search);
            const langFromUrl = urlParams.get('lang');
            console.log('[Scalar] getLanguage() - URL:', window.location.href);
            console.log('[Scalar] getLanguage() - langFromUrl:', langFromUrl);
            
            if (langFromUrl && (langFromUrl === 'en' || langFromUrl === 'vi')) {
                console.log('[Scalar] getLanguage() - Using language from URL:', langFromUrl);
                return langFromUrl;
            }
            const langFromStorage = localStorage.getItem('api-docs-language');
            console.log('[Scalar] getLanguage() - langFromStorage:', langFromStorage);
            if (langFromStorage && (langFromStorage === 'en' || langFromStorage === 'vi')) {
                console.log('[Scalar] getLanguage() - Using language from storage:', langFromStorage);
                return langFromStorage;
            }
            console.log('[Scalar] getLanguage() - Defaulting to English');
            return 'en'; // Default to English
        }

        // Lưu ngôn ngữ đã chọn
        function saveLanguage(lang) {
            localStorage.setItem('api-docs-language', lang);
            const url = new URL(window.location);
            url.searchParams.set('lang', lang);
            window.history.replaceState({}, '', url);
        }

        // Khởi tạo Scalar với ngôn ngữ đã chọn
        async function initializeScalar(language, forceRefresh = false) {
            let config;
            try {
                config = getServerConfig();
            } catch (error) {
                console.error('Error getting server config:', error);
                config = getFallbackConfig();
            }
            
            const baseUrl = config.baseUrl || window.location.origin;
            const versionStr = config.version || 'v1';
            const configFallbackUrl = config.fallbackUrl || (window.location.origin + '/v1/openapi.yaml');
            
            // Build spec URL - try with language first, fallback to default
            let specUrl;
            let fallbackUrl;
            if (versionStr && versionStr !== '' && versionStr !== '""' && versionStr !== 'null') {
                specUrl = baseUrl + '/' + versionStr + '/openapi/' + language + '/openapi.yaml';
                fallbackUrl = baseUrl + '/' + versionStr + '/openapi.yaml';
            } else {
                specUrl = baseUrl + '/openapi/' + language + '/openapi.yaml';
                fallbackUrl = baseUrl + '/openapi.yaml';
            }
            
            // Add cache-busting parameter when force refresh is needed (e.g., language change)
            if (forceRefresh) {
                const cacheBuster = '?_t=' + Date.now();
                specUrl += cacheBuster;
                fallbackUrl += cacheBuster;
                console.log('[Scalar] Added cache-busting parameter to force refresh');
            }
            
            // Use config fallback URL if our computed fallback is not available
            // (config fallback might be more reliable)
            if (!fallbackUrl || fallbackUrl === configFallbackUrl) {
                // Keep our computed fallback
            } else {
                // Prefer config fallback if it's different and might be more reliable
                console.log('Using config fallback URL as alternative:', configFallbackUrl);
            }
            
            console.log('[Scalar] initializeScalar() called with language:', language);
            console.log('[Scalar] Initializing Scalar with spec URL:', specUrl);
            console.log('[Scalar] Fallback URL:', fallbackUrl);
            console.log('[Scalar] Base URL:', baseUrl);
            console.log('[Scalar] Version:', versionStr);

            // Get the api-reference element
            const apiRef = document.getElementById('api-reference');
            if (!apiRef) {
                console.error('api-reference element not found');
                return Promise.reject(new Error('api-reference element not found'));
            }

            // Clear old content completely - force remove element and recreate to ensure clean state
            console.log('[Scalar] Clearing old content, current innerHTML length:', apiRef.innerHTML.length);
            
            // Store parent and position
            const parent = apiRef.parentNode;
            const nextSibling = apiRef.nextSibling;
            
            // Remove old element completely
            apiRef.remove();
            
            // Create fresh element with new spec URL
            const newApiRef = document.createElement('div');
            newApiRef.id = 'api-reference';
            newApiRef.setAttribute('data-spec-url', specUrl);
            
            // Insert at same position
            if (nextSibling) {
                parent.insertBefore(newApiRef, nextSibling);
            } else {
                parent.appendChild(newApiRef);
            }
            
            console.log('[Scalar] Created fresh api-reference element with data-spec-url:', specUrl);
            console.log('[Scalar] data-spec-url after setting:', newApiRef.getAttribute('data-spec-url'));
            
            // Always use manual initialization for better control, especially when switching languages
            // First ensure Scalar script is loaded, then initialize
            return waitForScalarAndManualInit(specUrl, fallbackUrl, baseUrl);
            
            async function waitForScalarAndManualInit(currentSpecUrl, currentFallbackUrl, currentBaseUrl) {
                // Get the fresh api-reference element
                const freshApiRef = document.getElementById('api-reference');
                if (!freshApiRef) {
                    console.error('[Scalar] api-reference element not found after recreation');
                    return Promise.reject(new Error('api-reference element not found'));
                }
                
                // Verify the spec URL is set correctly
                const elementSpecUrl = freshApiRef.getAttribute('data-spec-url');
                if (elementSpecUrl !== currentSpecUrl) {
                    console.warn('[Scalar] Spec URL mismatch. Expected:', currentSpecUrl, 'Got:', elementSpecUrl);
                    freshApiRef.setAttribute('data-spec-url', currentSpecUrl);
                }
                
                // First, ensure Scalar script is loaded
                console.log('[Scalar] Ensuring Scalar script is loaded...');
                try {
                    await loadScalarScript();
                    console.log('[Scalar] Scalar script load completed');
                } catch (loadError) {
                    console.error('[Scalar] Failed to load Scalar script:', loadError);
                    // Continue anyway, might already be loaded
                }
                
                // Wait for ScalarApiReference to be available - check for actual ScalarApiReference object
                let retries = 0;
                const maxRetries = 150; // 15 seconds - give even more time for script to fully load
                while (retries < maxRetries) {
                    // Check directly for ScalarApiReference (not through helper to avoid loadScalarScript)
                    if (typeof window.ScalarApiReference !== 'undefined' && 
                        window.ScalarApiReference !== window.loadScalarScript &&
                        typeof window.ScalarApiReference === 'object' &&
                        (window.ScalarApiReference.default || window.ScalarApiReference.ApiReference)) {
                        console.log('[Scalar] ScalarApiReference found, initializing manually with URL:', currentSpecUrl);
                        // Always use manual initialization for better control
                        return initScalar(currentSpecUrl, currentFallbackUrl, currentBaseUrl);
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                // If Scalar didn't load, try manual initialization anyway
                console.warn('[Scalar] ScalarApiReference not found after waiting, trying manual init anyway');
                return initScalar(currentSpecUrl, currentFallbackUrl, currentBaseUrl);
            }

            // Helper function to check if Scalar is available - check all possible ways
            function isScalarAvailable() {
                // Check various possible global names
                if (typeof ScalarApiReference !== 'undefined') return true;
                if (typeof window.ScalarApiReference !== 'undefined') return true;
                if (window.ScalarApiReference) return true;
                if (typeof Scalar !== 'undefined') return true;
                if (typeof window.Scalar !== 'undefined') return true;
                if (window.Scalar) return true;
                
                // Check if script has loaded by looking for any Scalar-related globals
                for (let key in window) {
                    if (key.includes('Scalar') || key.includes('scalar')) {
                        console.log('Found Scalar-related global:', key);
                        return true;
                    }
                }
                
                return false;
            }
            
            // Helper function to get ScalarApiReference - try all possible ways
            function getScalarApiReference() {
                // Try ScalarApiReference first (the actual API)
                if (typeof ScalarApiReference !== 'undefined' && ScalarApiReference !== window.loadScalarScript) {
                    return ScalarApiReference;
                }
                if (typeof window.ScalarApiReference !== 'undefined' && window.ScalarApiReference !== window.loadScalarScript) {
                    return window.ScalarApiReference;
                }
                if (window.ScalarApiReference && window.ScalarApiReference !== window.loadScalarScript) {
                    return window.ScalarApiReference;
                }
                
                // Try Scalar (alternative name)
                if (typeof Scalar !== 'undefined' && Scalar !== window.loadScalarScript) {
                    return Scalar;
                }
                if (typeof window.Scalar !== 'undefined' && window.Scalar !== window.loadScalarScript) {
                    return window.Scalar;
                }
                if (window.Scalar && window.Scalar !== window.loadScalarScript) {
                    return window.Scalar;
                }
                
                // Search for any Scalar-related global, but exclude loadScalarScript
                for (let key in window) {
                    if ((key.includes('Scalar') || key.includes('scalar')) && key !== 'loadScalarScript') {
                        const obj = window[key];
                        // Only return if it's not a function (ScalarApiReference is an object, not a function)
                        // Or if it has a default property (like ScalarApiReference.default)
                        if (obj && (obj.default || (typeof obj !== 'function' && typeof obj === 'object'))) {
                            console.log('Using Scalar global:', key);
                            return obj;
                        }
                    }
                }
                
                return null;
            }
            
            // Đợi Scalar script load xong rồi mới khởi tạo
            async function initScalar(currentSpecUrl, currentFallbackUrl, currentBaseUrl) {
                try {
                    // Use parameters passed in to avoid closure issues
                    const specUrlToUse = currentSpecUrl || specUrl;
                    const fallbackUrlToUse = currentFallbackUrl || fallbackUrl;
                    const baseUrlToUse = currentBaseUrl || baseUrl;
                    
                    // Get fresh reference to api-reference element
                    const freshApiRef = document.getElementById('api-reference');
                    if (!freshApiRef) {
                        throw new Error('api-reference element not found in initScalar');
                    }
                    
                    // Verify spec URL is correct
                    const elementSpecUrl = freshApiRef.getAttribute('data-spec-url');
                    console.log('[Scalar] initScalar - element spec URL:', elementSpecUrl);
                    console.log('[Scalar] initScalar - parameter spec URL:', specUrlToUse);
                    
                    // Use the URL from parameter (most reliable)
                    const urlToUse = specUrlToUse;
                    
                    // First, check which URL is available
                    // Remove cache-busting parameter for HEAD request (server might not like it)
                    const urlForCheck = urlToUse.split('?')[0];
                    const fallbackForCheck = fallbackUrlToUse.split('?')[0];
                    let finalUrl = urlToUse; // Keep original URL with cache-busting for actual fetch
                    
                    try {
                        console.log('[Scalar] Checking if language-specific URL exists:', urlForCheck);
                        const response = await fetch(urlForCheck, { 
                            method: 'HEAD',
                            cache: 'no-cache', // Force fresh fetch
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        if (!response.ok) {
                            throw new Error(`URL returned ${response.status}`);
                        }
                        console.log('[Scalar] ✅ Language-specific URL exists, using it');
                        finalUrl = urlToUse; // Use URL with cache-busting
                    } catch (urlError) {
                        console.warn('[Scalar] Language-specific URL not found, trying fallback:', fallbackForCheck);
                        try {
                            const fallbackResponse = await fetch(fallbackForCheck, { 
                                method: 'HEAD',
                                cache: 'no-cache',
                                headers: {
                                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                                    'Pragma': 'no-cache',
                                    'Expires': '0'
                                }
                            });
                            if (fallbackResponse.ok) {
                                console.log('[Scalar] ✅ Fallback URL exists, using it');
                                finalUrl = fallbackUrlToUse; // Use fallback with cache-busting
                            } else {
                                throw new Error(`Fallback URL returned ${fallbackResponse.status}`);
                            }
                        } catch (fallbackError) {
                            console.error('[Scalar] Both URLs failed, using language-specific URL anyway:', fallbackError);
                            finalUrl = urlToUse; // Use original URL, let Scalar handle the error
                        }
                    }
                    
                    // Get server URL from config or use current origin
                    const serverUrl = baseUrlToUse || window.location.origin;
                    
                    // Create configuration with the final URL (use new format - not deprecated)
                    // Ensure cache-busting is preserved and add additional cache control
                    const configuration = {
                        url: finalUrl,  // New format - not deprecated (includes cache-busting if forceRefresh)
                        theme: 'default',
                        layout: 'modern',
                        // Enable API testing with proper server URL
                        defaultHttpClient: {
                            targetKey: 'javascript',
                            clientKey: 'fetch'
                        },
                        // Configure server for API testing
                        withCredentials: false,
                        // Proxy configuration if needed (optional)
                        proxy: undefined,
                        // Force no-cache for spec fetching
                        fetchOptions: {
                            cache: 'no-store',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        },
                        // Custom CSS để cải thiện định dạng response body
                        // Note: JSON enhancement được xử lý bởi script riêng
                        customCss: `
                            /* Cải thiện hiển thị response section tổng thể */
                            .scalar-api-reference .response-section {
                                padding: 20px !important;
                                background: #ffffff !important;
                                border: 1px solid #e1e4e8 !important;
                                border-radius: 6px !important;
                                margin-top: 16px !important;
                            }
                            
                            /* Cải thiện hiển thị response headers */
                            .scalar-api-reference .response-headers {
                                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace !important;
                                font-size: 12px !important;
                            }
                            
                            /* Đảm bảo response body có không gian đủ */
                            .scalar-api-reference .response-body {
                                margin: 12px 0 !important;
                            }
                        `
                    };
                    console.log('Final URL for Scalar:', finalUrl);
                    console.log('Server URL for API testing:', serverUrl);
                    console.log('Configuration:', configuration);
                    
                    // Ensure Scalar script is loaded
                    if (!isScalarAvailable()) {
                        console.log('Scalar not loaded yet, attempting to load...');
                        try {
                            await loadScalarScript();
                        } catch (loadError) {
                            console.error('Failed to load Scalar script:', loadError);
                            // Try using data-configuration method as fallback
                            console.log('Trying data-configuration method...');
                            // Configuration will be created later, use default for now
                            useDataConfigurationMethod();
                            return;
                        }
                    }
                    
                    // Wait a bit more to ensure it's fully initialized
                    let retries = 0;
                    const maxRetries = 100; // 10 seconds
                    while (!isScalarAvailable() && retries < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retries++;
                    }
                    
                    const ScalarRef = getScalarApiReference();
                    if (!ScalarRef) {
                        console.warn('ScalarApiReference not found, trying data-configuration method...');
                        // Configuration will be created later, use default for now
                        useDataConfigurationMethod();
                        return;
                    }
                    
                    // Log the structure to understand what we have
                    console.log('ScalarRef type:', typeof ScalarRef);
                    console.log('ScalarRef:', ScalarRef);
                    console.log('ScalarRef.default:', ScalarRef.default);
                    console.log('ScalarRef keys:', Object.keys(ScalarRef || {}));
                    
                    // Scalar đã load, khởi tạo trực tiếp
                    try {
                        console.log('Initializing Scalar with configuration:', configuration);
                        
                        // Try multiple ways to initialize
                        let scalarInstance = null;
                        
                        // Method 1: ScalarRef.default
                        if (ScalarRef.default && typeof ScalarRef.default === 'function') {
                            scalarInstance = ScalarRef.default;
                            console.log('Using ScalarRef.default');
                        }
                        // Method 2: ScalarRef itself
                        else if (typeof ScalarRef === 'function') {
                            scalarInstance = ScalarRef;
                            console.log('Using ScalarRef directly');
                        }
                        // Method 3: ScalarRef.ApiReference
                        else if (ScalarRef.ApiReference && typeof ScalarRef.ApiReference === 'function') {
                            scalarInstance = ScalarRef.ApiReference;
                            console.log('Using ScalarRef.ApiReference');
                        }
                        // Method 4: ScalarRef.create
                        else if (ScalarRef.create && typeof ScalarRef.create === 'function') {
                            scalarInstance = ScalarRef.create;
                            console.log('Using ScalarRef.create');
                        }
                        // Method 5: Check for any function property
                        else {
                            for (let key in ScalarRef) {
                                if (typeof ScalarRef[key] === 'function') {
                                    console.log('Found function property:', key);
                                    scalarInstance = ScalarRef[key];
                                    break;
                                }
                            }
                        }
                        
                        if (scalarInstance && typeof scalarInstance === 'function') {
                            const apiRef = document.getElementById('api-reference');
                            if (!apiRef) {
                                console.error('api-reference element not found');
                                return;
                            }
                            
                            // Destroy previous instance if exists
                            if (window.scalarInstance) {
                                try {
                                    console.log('Destroying previous Scalar instance...');
                                    if (window.scalarInstance.destroy && typeof window.scalarInstance.destroy === 'function') {
                                        window.scalarInstance.destroy();
                                    } else if (window.scalarInstance.unmount && typeof window.scalarInstance.unmount === 'function') {
                                        window.scalarInstance.unmount();
                                    } else if (window.scalarInstance.app && window.scalarInstance.app.unmount) {
                                        window.scalarInstance.app.unmount();
                                    }
                                } catch (destroyError) {
                                    console.warn('Error destroying previous instance:', destroyError);
                                }
                                window.scalarInstance = null;
                            }
                            
                            // Try multiple ways to call createApiReference
                            let initialized = false;
                            
                            // Method 1: With target selector (try sync and async)
                            try {
                                console.log('Method 1: Calling with target selector');
                                const result1 = scalarInstance({
                                    ...configuration,
                                    target: '#api-reference'
                                });
                                
                                // Store instance reference for cleanup
                                if (result1) {
                                    window.scalarInstance = result1;
                                }
                                
                                console.log('Method 1 result:', result1);
                                console.log('Method 1 result keys:', result1 ? Object.keys(result1) : 'null');
                                
                                // Check if result has an app that needs mounting
                                if (result1 && result1.app) {
                                    console.log('Found app in result, checking if it needs mounting...');
                                    console.log('app type:', typeof result1.app);
                                    console.log('app keys:', result1.app ? Object.keys(result1.app) : 'null');
                                    
                                    // Try mounting the app if it has a mount method
                                    if (result1.app && typeof result1.app.mount === 'function') {
                                        console.log('Mounting app to #api-reference...');
                                        try {
                                            result1.app.mount('#api-reference');
                                            console.log('✅ App mounted successfully to #api-reference');
                                            initialized = true;
                                        } catch (mountError) {
                                            console.warn('Mount to #api-reference failed:', mountError);
                                            // Try mounting to element directly
                                            try {
                                                result1.app.mount(apiRef);
                                                console.log('✅ App mounted successfully to element');
                                                initialized = true;
                                            } catch (mountError2) {
                                                console.warn('Mount to element also failed:', mountError2);
                                                // Still mark as initialized, maybe it will work
                                                initialized = true;
                                            }
                                        }
                                    } else {
                                        console.log('App does not have mount method or app is null');
                                        console.log('Result structure:', {
                                            hasApp: !!result1.app,
                                            appType: typeof result1.app,
                                            appKeys: result1.app ? Object.keys(result1.app) : null
                                        });
                                        initialized = true;
                                    }
                                }
                                
                                // Check if it's a promise
                                if (!initialized && result1 && typeof result1.then === 'function') {
                                    console.log('Method 1 returned a promise, awaiting...');
                                    result1.then((resolvedResult) => {
                                        console.log('Method 1 promise resolved:', resolvedResult);
                                        // Check if resolved result has app
                                        if (resolvedResult && resolvedResult.app && typeof resolvedResult.app.mount === 'function') {
                                            try {
                                                resolvedResult.app.mount('#api-reference');
                                                console.log('✅ App mounted from promise');
                                            } catch (mountErr) {
                                                console.warn('Mount from promise failed, trying element:', mountErr);
                                                try {
                                                    resolvedResult.app.mount(apiRef);
                                                    console.log('✅ App mounted to element from promise');
                                                } catch (mountErr2) {
                                                    console.warn('Mount to element from promise also failed:', mountErr2);
                                                }
                                            }
                                        }
                                        initialized = true;
                                    }).catch(err => {
                                        console.warn('Method 1 promise rejected:', err);
                                    });
                                } else if (!initialized) {
                                    initialized = true;
                                }
                            } catch (e1) {
                                console.warn('Method 1 failed:', e1.message);
                            }
                            
                            // Method 2: With element directly (if createApiReference) - try different formats
                            if (!initialized && scalarInstance === ScalarRef.createApiReference) {
                                // Helper function to mount app if present
                                const tryMountApp = (result, methodName) => {
                                    if (result && result.app && typeof result.app.mount === 'function') {
                                        console.log(`Mounting app from ${methodName}...`);
                                        try {
                                            result.app.mount('#api-reference');
                                            console.log(`${methodName} app mounted successfully`);
                                            initialized = true;
                                            return true;
                                        } catch (mountErr) {
                                            console.warn(`${methodName} mount failed, trying element:`, mountErr);
                                            try {
                                                result.app.mount(apiRef);
                                                console.log(`${methodName} app mounted to element successfully`);
                                                initialized = true;
                                                return true;
                                            } catch (mountErr2) {
                                                console.warn(`${methodName} mount to element also failed:`, mountErr2);
                                                return false;
                                            }
                                        }
                                    }
                                    return false;
                                };
                                
                                // Try 2a: element + config object
                                try {
                                    console.log('Method 2a: createApiReference(element, config)');
                                    const result2a = ScalarRef.createApiReference(apiRef, configuration);
                                    console.log('Method 2a result:', result2a);
                                    
                                    // Store instance reference
                                    if (result2a) {
                                        window.scalarInstance = result2a;
                                    }
                                    
                                    // Check if it's a promise
                                    if (result2a && typeof result2a.then === 'function') {
                                        console.log('Method 2a returned a promise, awaiting...');
                                        result2a.then((resolvedResult) => {
                                            console.log('Method 2a promise resolved:', resolvedResult);
                                            if (resolvedResult) {
                                                window.scalarInstance = resolvedResult;
                                            }
                                            if (!tryMountApp(resolvedResult, 'Method 2a')) {
                                                initialized = true;
                                            }
                                        }).catch(err => {
                                            console.warn('Method 2a promise rejected:', err);
                                        });
                                    } else {
                                        if (!tryMountApp(result2a, 'Method 2a')) {
                                            initialized = true;
                                        }
                                    }
                                } catch (e2a) {
                                    console.warn('Method 2a failed:', e2a.message);
                                    
                                    // Try 2b: element + spec URL string
                                    try {
                                        console.log('Method 2b: createApiReference(element, specUrl)');
                                        const result2b = ScalarRef.createApiReference(apiRef, configuration.url);
                                        console.log('Method 2b result:', result2b);
                                        
                                        // Store instance reference
                                        if (result2b) {
                                            window.scalarInstance = result2b;
                                        }
                                        
                                        if (result2b && typeof result2b.then === 'function') {
                                            result2b.then((resolvedResult) => {
                                                console.log('Method 2b promise resolved:', resolvedResult);
                                                if (resolvedResult) {
                                                    window.scalarInstance = resolvedResult;
                                                }
                                                if (!tryMountApp(resolvedResult, 'Method 2b')) {
                                                    initialized = true;
                                                }
                                            }).catch(err => {
                                                console.warn('Method 2b promise rejected:', err);
                                            });
                                        } else {
                                            if (!tryMountApp(result2b, 'Method 2b')) {
                                                initialized = true;
                                            }
                                        }
                                    } catch (e2b) {
                                        console.warn('Method 2b failed:', e2b.message);
                                        
                                        // Try 2c: just element (maybe it reads from data-configuration)
                                        try {
                                            console.log('Method 2c: createApiReference(element)');
                                            const result2c = ScalarRef.createApiReference(apiRef);
                                            console.log('Method 2c result:', result2c);
                                            
                                            // Store instance reference
                                            if (result2c) {
                                                window.scalarInstance = result2c;
                                            }
                                            
                                            if (result2c && typeof result2c.then === 'function') {
                                                result2c.then((resolvedResult) => {
                                                    console.log('Method 2c promise resolved:', resolvedResult);
                                                    if (resolvedResult) {
                                                        window.scalarInstance = resolvedResult;
                                                    }
                                                    if (!tryMountApp(resolvedResult, 'Method 2c')) {
                                                        initialized = true;
                                                    }
                                                }).catch(err => {
                                                    console.warn('Method 2c promise rejected:', err);
                                                });
                                            } else {
                                                if (!tryMountApp(result2c, 'Method 2c')) {
                                                    initialized = true;
                                                }
                                            }
                                        } catch (e2c) {
                                            console.warn('Method 2c failed:', e2c.message);
                                        }
                                    }
                                }
                            }
                            
                            // Method 3: With element and target
                            if (!initialized) {
                                try {
                                    console.log('Method 3: Calling with element in config');
                                    const result3 = scalarInstance({
                                        ...configuration,
                                        target: apiRef
                                    });
                                    
                                    // Store instance reference
                                    if (result3) {
                                        window.scalarInstance = result3;
                                    }
                                    
                                    console.log('Method 3 result:', result3);
                                    initialized = true;
                                } catch (e3) {
                                    console.warn('Method 3 failed:', e3.message);
                                }
                            }
                            
                            // Wait a bit for async operations
                            setTimeout(async () => {
                                if (initialized) {
                                    // Check if element was populated after a delay
                                    const apiRefCheck = document.getElementById('api-reference');
                                    if (apiRefCheck) {
                                        console.log('Checking api-reference after initialization...');
                                        console.log('api-reference innerHTML length:', apiRefCheck.innerHTML.length);
                                        console.log('api-reference children count:', apiRefCheck.children.length);
                                        console.log('api-reference computed style display:', window.getComputedStyle(apiRefCheck).display);
                                        console.log('api-reference first 500 chars:', apiRefCheck.innerHTML.substring(0, 500));
                                        
                                        // Only hide actual skeleton loaders - be very careful not to hide real content
                                        const hideSkeletons = () => {
                                            // Only target elements that are clearly skeletons and empty
                                            const skeletons = apiRefCheck.querySelectorAll('[data-skeleton="true"], [class*="skeleton"]:empty, [aria-label*="loading"][aria-busy="true"]:empty');
                                            skeletons.forEach(el => {
                                                // Double check it's actually a skeleton and not content
                                                if (el && el.parentElement && el.children.length === 0 && el.textContent.trim() === '') {
                                                    const hasContent = el.querySelector('*');
                                                    if (!hasContent) {
                                                        el.style.display = 'none';
                                                    }
                                                }
                                            });
                                        };
                                        
                                        // Only run after content is loaded, and only once
                                        if (apiRefCheck.innerHTML.length > 100) {
                                            setTimeout(hideSkeletons, 2000);
                                        }
                                        
                                        if (apiRefCheck.innerHTML.length === 0 || 
                                            (apiRefCheck.children.length === 0 && apiRefCheck.innerHTML.trim().length < 50)) {
                                            console.warn('api-reference is still empty after 3 seconds');
                                            console.warn('Trying data-configuration method as fallback...');
                                            useDataConfigurationMethod();
                                        } else {
                                            console.log('✅ Scalar content rendered successfully!');
                                            
                                            // Force visibility - check if content is hidden
                                            const computedStyle = window.getComputedStyle(apiRefCheck);
                                            console.log('Element visibility:', {
                                                display: computedStyle.display,
                                                visibility: computedStyle.visibility,
                                                opacity: computedStyle.opacity,
                                                height: computedStyle.height,
                                                width: computedStyle.width
                                            });
                                            
                                            // Ensure element is visible
                                            if (computedStyle.display === 'none') {
                                                console.warn('Element is hidden, forcing display...');
                                                apiRefCheck.style.display = 'block';
                                            }
                                            if (computedStyle.visibility === 'hidden') {
                                                console.warn('Element visibility is hidden, forcing visible...');
                                                apiRefCheck.style.visibility = 'visible';
                                            }
                                            if (parseFloat(computedStyle.opacity) === 0) {
                                                console.warn('Element opacity is 0, forcing opacity...');
                                                apiRefCheck.style.opacity = '1';
                                            }
                                            
                                            // Force CSS to ensure visibility
                                            apiRefCheck.style.setProperty('display', 'block', 'important');
                                            apiRefCheck.style.setProperty('visibility', 'visible', 'important');
                                            apiRefCheck.style.setProperty('opacity', '1', 'important');
                                            apiRefCheck.style.setProperty('position', 'relative', 'important');
                                            apiRefCheck.style.setProperty('z-index', '1', 'important');
                                            
                                            // Check if children are visible
                                            const firstChild = apiRefCheck.firstElementChild;
                                            if (firstChild) {
                                                const childStyle = window.getComputedStyle(firstChild);
                                                console.log('First child visibility:', {
                                                    display: childStyle.display,
                                                    visibility: childStyle.visibility,
                                                    opacity: childStyle.opacity,
                                                    position: childStyle.position,
                                                    zIndex: childStyle.zIndex
                                                });
                                                
                                                // Force child visibility
                                                firstChild.style.setProperty('display', 'block', 'important');
                                                firstChild.style.setProperty('visibility', 'visible', 'important');
                                                firstChild.style.setProperty('opacity', '1', 'important');
                                                
                                                // Check if element is in viewport
                                                const rect = apiRefCheck.getBoundingClientRect();
                                                console.log('Element position in viewport:', {
                                                    top: rect.top,
                                                    left: rect.left,
                                                    bottom: rect.bottom,
                                                    right: rect.right,
                                                    width: rect.width,
                                                    height: rect.height,
                                                    inViewport: rect.top >= 0 && rect.left >= 0 && 
                                                               rect.bottom <= window.innerHeight && 
                                                               rect.right <= window.innerWidth
                                                });
                                                
                                                // Scroll to element if not in viewport
                                                if (rect.top < 0 || rect.top > window.innerHeight) {
                                                    console.log('Element not in viewport, scrolling to it...');
                                                    apiRefCheck.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                }
                                            }
                                            
                                            // Check for any overlaying elements
                                            const elementsAtPoint = document.elementsFromPoint(
                                                window.innerWidth / 2, 
                                                window.innerHeight / 2
                                            );
                                            console.log('Elements at center of viewport:', elementsAtPoint.slice(0, 5).map(el => ({
                                                tag: el.tagName,
                                                id: el.id,
                                                class: el.className,
                                                zIndex: window.getComputedStyle(el).zIndex
                                            })));
                                        }
                                    }
                                } else {
                                    console.error('All initialization methods failed');
                                    useDataConfigurationMethod();
                                }
                            }, 3000); // Wait 3 seconds for async operations
                        } else {
                            console.error('No valid Scalar function found, structure:', ScalarRef);
                            // Try data-configuration method instead
                            useDataConfigurationMethod();
                            return;
                        }
                    } catch (error) {
                        console.error('Error initializing Scalar:', error);
                        // Fallback: thử dùng fallbackUrl với format mới
                        try {
                            const fallbackConfig = {
                                url: fallbackUrl,  // New format - not deprecated
                                theme: 'default',
                                layout: 'modern',
                                // Custom CSS để cải thiện định dạng response body
                                customCss: configuration.customCss
                            };
                            console.log('Trying fallback URL with new format:', fallbackUrl);
                            const ScalarRef2 = getScalarApiReference();
                            if (!ScalarRef2) {
                                throw new Error('ScalarApiReference not available');
                            }
                            
                            // Try the same methods as above
                            let scalarInstance = ScalarRef2.default || ScalarRef2;
                            if (ScalarRef2.ApiReference && typeof ScalarRef2.ApiReference === 'function') {
                                scalarInstance = ScalarRef2.ApiReference;
                            }
                            
                            if (typeof scalarInstance === 'function') {
                                const fallbackResult = scalarInstance({
                                    ...fallbackConfig,
                                    target: '#api-reference'
                                });
                                
                                // Try mounting app if present
                                // Store instance reference
                                if (fallbackResult) {
                                    window.scalarInstance = fallbackResult;
                                }
                                
                                if (fallbackResult && fallbackResult.app && typeof fallbackResult.app.mount === 'function') {
                                    try {
                                        fallbackResult.app.mount('#api-reference');
                                        console.log('✅ Fallback URL app mounted successfully');
                                    } catch (mountErr) {
                                        console.warn('Fallback mount failed:', mountErr);
                                    }
                                }
                                console.log('Fallback URL initialization succeeded');
                            } else {
                                throw new Error('Scalar instance is not a function');
                            }
                        } catch (fallbackError) {
                            console.error('Fallback also failed:', fallbackError);
                            // Last resort: use data-configuration
                            console.log('Trying data-configuration method as last resort...');
                            useDataConfigurationMethod(configuration);
                        }
                    }
                } catch (error) {
                    console.error('Error in initScalar:', error);
                    // Last resort: use data-configuration
                    console.log('Trying data-configuration method as last resort...');
                    useDataConfigurationMethod(configuration);
                }
            }
            
            // Use data-configuration method (like the C++ code does)
            function useDataConfigurationMethod(configToUse = null) {
                console.log('Using data-configuration method to initialize Scalar');
                const apiRef = document.getElementById('api-reference');
                if (apiRef) {
                    // Use provided config or create a default one
                    const defaultCustomCss = `
                        .scalar-api-reference .response-section {
                            padding: 20px !important;
                            background: #ffffff !important;
                            border: 1px solid #e1e4e8 !important;
                            border-radius: 6px !important;
                            margin-top: 16px !important;
                        }
                        .scalar-api-reference .response-body {
                            margin: 12px 0 !important;
                        }
                    `;
                    const config = configToUse || {
                        url: fallbackUrl || specUrl,
                        theme: 'default',
                        layout: 'modern',
                        customCss: defaultCustomCss
                    };
                    
                    // Don't clear content if it already has content (might be from previous mount)
                    if (apiRef.innerHTML.trim().length < 100) {
                        apiRef.innerHTML = '';
                    } else {
                        console.log('api-reference already has content, keeping it');
                    }
                    
                    // Remove any existing config script to prevent auto-initialization conflicts
                    const existingConfig = document.getElementById('api-reference-config');
                    if (existingConfig) {
                        existingConfig.remove();
                    }
                    
                    // Remove data-configuration from div to prevent auto-initialization
                    apiRef.removeAttribute('data-configuration');
                    
                    // Don't use data-configuration method if we already have content
                    // Instead, try manual initialization
                    if (apiRef.innerHTML.trim().length > 100) {
                        console.log('Content already exists, skipping data-configuration method');
                        return;
                    }
                    
                    // Try method 1: Set data-configuration on the div itself
                    apiRef.setAttribute('data-configuration', JSON.stringify(config));
                    console.log('Set data-configuration on #api-reference div');
                    
                    // Try method 2: Also create a script element with data-configuration (like C++ code)
                    const configScript = document.createElement('script');
                    configScript.id = 'api-reference-config';
                    configScript.setAttribute('data-configuration', JSON.stringify(config));
                    document.body.appendChild(configScript);
                    console.log('Created data-configuration script element in body');
                    
                    // Scalar standalone.js should auto-initialize when it sees this
                    console.log('Waiting for Scalar to auto-initialize...');
                    
                    // Wait a bit and check if Scalar initialized
                    setTimeout(() => {
                        // Check if api-reference has content (Scalar initialized)
                        const hasContent = apiRef.children.length > 0 && 
                                         !apiRef.querySelector('#api-reference-config') &&
                                         apiRef.innerHTML.trim().length > 0;
                        
                        if (!hasContent) {
                            console.warn('Scalar did not auto-initialize from data-configuration');
                            console.log('api-reference content:', apiRef.innerHTML.substring(0, 200));
                            
                            // Try to find Scalar and initialize manually
                            const ScalarRef = getScalarApiReference();
                            if (ScalarRef) {
                                console.log('Found ScalarRef, trying manual initialization with all methods...');
                                try {
                                    // Try all possible initialization methods
                                    const methods = [
                                        () => ScalarRef.default,
                                        () => ScalarRef,
                                        () => ScalarRef.ApiReference,
                                        () => ScalarRef.create,
                                        () => {
                                            for (let key in ScalarRef) {
                                                if (typeof ScalarRef[key] === 'function') {
                                                    return ScalarRef[key];
                                                }
                                            }
                                            return null;
                                        }
                                    ];
                                    
                                    let initialized = false;
                                    for (let getMethod of methods) {
                                        try {
                                            const method = getMethod();
                                            if (method && typeof method === 'function') {
                                                console.log('Trying initialization method:', getMethod.toString().substring(0, 50));
                                                const result = method({
                                                    ...config,
                                                    target: '#api-reference'
                                                });
                                                console.log('Method result:', result);
                                                
                                                // Check if result has app that needs mounting
                                                if (result && result.app && typeof result.app.mount === 'function') {
                                                    console.log('Mounting app from result...');
                                                    try {
                                                        result.app.mount('#api-reference');
                                                        console.log('App mounted successfully!');
                                                        initialized = true;
                                                        break;
                                                    } catch (mountErr) {
                                                        console.warn('Mount failed, trying element:', mountErr);
                                                        try {
                                                            result.app.mount(apiRef);
                                                            console.log('App mounted to element successfully!');
                                                            initialized = true;
                                                            break;
                                                        } catch (mountErr2) {
                                                            console.warn('Mount to element also failed:', mountErr2);
                                                        }
                                                    }
                                                } else {
                                                    console.log('No app to mount, assuming auto-initialized');
                                                    initialized = true;
                                                    break;
                                                }
                                            }
                                        } catch (e) {
                                            console.warn('Method failed:', e.message);
                                        }
                                    }
                                    
                                    if (!initialized) {
                                        throw new Error('All initialization methods failed');
                                    }
                                } catch (e) {
                                    console.error('Manual initialization failed:', e);
                                    showScalarInitError(e);
                                }
                            } else {
                                console.error('ScalarApiReference still not available');
                                showScalarLoadError();
                            }
                        } else {
                            console.log('Scalar auto-initialized successfully from data-configuration');
                        }
                    }, 3000); // Wait 3 seconds for auto-initialization
                }
            }
            
            // Helper function to show load error
            function showScalarLoadError() {
                const apiRef = document.getElementById('api-reference');
                if (apiRef) {
                    apiRef.innerHTML = 
                        '<div style="padding: 40px; text-align: center; max-width: 600px; margin: 50px auto;">' +
                        '<h2 style="color: #d32f2f;">Error loading API documentation</h2>' +
                        '<p style="color: #666; margin: 20px 0;">Scalar script failed to load from all CDN sources. This could be due to:</p>' +
                        '<ul style="text-align: left; display: inline-block; color: #666;">' +
                        '<li>Network connectivity issues</li>' +
                        '<li>CDN blocking or unavailable (jsdelivr.net, unpkg.com)</li>' +
                        '<li>Browser tracking prevention blocking the CDN</li>' +
                        '<li>Firewall/proxy restrictions</li>' +
                        '</ul>' +
                        '<p style="color: #666; margin-top: 20px;">Please check your internet connection, disable tracking prevention for this site, or try refreshing the page.</p>' +
                        '<button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Page</button>' +
                        '</div>';
                }
            }
            
            // Helper function to show init error
            function showScalarInitError(error) {
                const apiRef = document.getElementById('api-reference');
                if (apiRef) {
                    apiRef.innerHTML = 
                        '<div style="padding: 20px; text-align: center;">' +
                        '<h2>Error loading API documentation</h2>' +
                        '<p>Failed to initialize Scalar. Error: ' + (error?.message || 'Unknown error') + '</p>' +
                        '<p>Please check browser console for details.</p>' +
                        '</div>';
                }
            }
        }

        // Xử lý thay đổi ngôn ngữ
        async function handleLanguageChange() {
            const select = document.getElementById('language-select');
            const selectedLang = select.value;
            saveLanguage(selectedLang);
            
            console.log('[Language Change] Switching to language:', selectedLang);
            
            // Reload page to ensure fresh content (most reliable solution)
            // This ensures:
            // 1. Server renders HTML with correct language parameter
            // 2. Scalar initializes fresh with correct data-spec-url
            // 3. No cache issues or stale content
            // The URL already has ?lang= parameter, so reload will fetch correct content
            window.location.reload();
        }

        // Khởi tạo
        function init() {
            const currentLang = getLanguage();
            const select = document.getElementById('language-select');
            if (select) {
                select.value = currentLang;
                select.addEventListener('change', handleLanguageChange);
            }
            
            // Set initial data-spec-url immediately so Scalar can auto-initialize when it loads
            const apiRef = document.getElementById('api-reference');
            console.log('[Scalar] init() - currentLang:', currentLang);
            console.log('[Scalar] init() - apiRef:', apiRef);
            if (apiRef) {
                const existingUrl = apiRef.getAttribute('data-spec-url');
                console.log('[Scalar] init() - existing data-spec-url:', existingUrl);
                
                const baseUrl = window.location.origin;
                const version = 'v1';
                const specUrl = baseUrl + '/' + version + '/openapi/' + currentLang + '/openapi.yaml';
                console.log('[Scalar] init() - computed specUrl:', specUrl);
                
                if (!existingUrl || existingUrl !== specUrl) {
                    apiRef.setAttribute('data-spec-url', specUrl);
                    console.log('[Scalar] init() - Set data-spec-url to:', specUrl);
                } else {
                    console.log('[Scalar] init() - data-spec-url already correct');
                }
                console.log('[Scalar] init() - Final data-spec-url:', apiRef.getAttribute('data-spec-url'));
            }
            
            // Also call initializeScalar to handle language switching
            // Đợi window load xong (bao gồm cả external scripts)
            if (document.readyState === 'complete') {
                // Page already fully loaded
                setTimeout(function() {
                    initializeScalar(currentLang).catch(err => {
                        console.error('Failed to initialize Scalar:', err);
                    });
                }, 500);
            } else {
                // Wait for window load event (fires after all resources loaded)
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        initializeScalar(currentLang).catch(err => {
                            console.error('Failed to initialize Scalar:', err);
                        });
                    }, 500);
                });
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM đã sẵn sàng
            init();
        }
    </script>
    
    <!-- JSON Display Enhancement Script -->
    <script>
        (function() {
            'use strict';
            
            // Icon SVG cho nút Copy
            const copyIconSvg = '<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 2.5H11.5C12.0523 2.5 12.5 2.94772 12.5 3.5V9.5C12.5 10.0523 12.0523 10.5 11.5 10.5H9.5V12.5C9.5 13.0523 9.05228 13.5 8.5 13.5H2.5C1.94772 13.5 1.5 13.0523 1.5 12.5V6.5C1.5 5.94772 1.94772 5.5 2.5 5.5H4.5V3.5C4.5 2.94772 4.94772 2.5 5.5 2.5ZM4.5 5.5H2.5V12.5H8.5V10.5H6.5C5.94772 10.5 5.5 10.0523 5.5 9.5V5.5H4.5ZM6.5 5.5V9.5H11.5V3.5H5.5V5.5H6.5Z"/></svg>';
            const checkIconSvg = '<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            
            // Hàm copy text vào clipboard
            async function copyToClipboard(text) {
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } else {
                        // Fallback cho browsers cũ
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        const success = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        return success;
                    }
                } catch (err) {
                    console.error('Failed to copy:', err);
                    return false;
                }
            }
            
            // Hàm lấy text thuần từ code element (loại bỏ HTML tags)
            function getPlainText(codeElement) {
                if (!codeElement) return '';
                
                // Nếu có textContent, dùng nó (đã loại bỏ HTML)
                if (codeElement.textContent) {
                    return codeElement.textContent;
                }
                
                // Fallback: clone và loại bỏ các span
                const clone = codeElement.cloneNode(true);
                const spans = clone.querySelectorAll('span');
                spans.forEach(span => {
                    const text = document.createTextNode(span.textContent);
                    span.parentNode.replaceChild(text, span);
                });
                return clone.textContent || clone.innerText || '';
            }
            
            // Hàm đếm số dòng trong text
            function countLines(text) {
                if (!text) return 0;
                return text.split('\n').length;
            }
            
            // Hàm tạo line numbers HTML
            function createLineNumbers(count) {
                const lines = [];
                for (let i = 1; i <= count; i++) {
                    lines.push(i);
                }
                return lines.join('\n');
            }
            
            // Hàm enhance JSON display cho một pre code block
            function enhanceJsonDisplay(preCodeBlock) {
                // Kiểm tra xem đã được enhance chưa
                if (preCodeBlock.closest('.json-display-wrapper')) {
                    return;
                }
                
                // Chỉ enhance trong response body area, không enhance trong request examples
                const isInResponse = preCodeBlock.closest('[class*="response"], [class*="Response"], [id*="response"], [id*="Response"]');
                const isInRequest = preCodeBlock.closest('[class*="request"], [class*="Request"], [class*="example"], [class*="Example"], [class*="curl"]');
                
                // Nếu không trong response area hoặc trong request area, skip
                if (!isInResponse || isInRequest) {
                    return;
                }
                
                const codeElement = preCodeBlock.querySelector('code');
                if (!codeElement) return;
                
                // Lấy text thuần
                const plainText = getPlainText(codeElement);
                if (!plainText || plainText.trim().length === 0) return;
                
                // Kiểm tra xem có phải JSON không (heuristic)
                const trimmed = plainText.trim();
                const looksLikeJson = (trimmed.startsWith('{') && trimmed.endsWith('}')) ||
                                     (trimmed.startsWith('[') && trimmed.endsWith(']'));
                
                if (!looksLikeJson) return;
                
                // Kiểm tra thêm: JSON phải có ít nhất một key-value pair hoặc array element
                // Tránh wrap các code blocks ngắn không phải JSON response
                if (trimmed.length < 10) return;
                
                // Kiểm tra có chứa JSON structure cơ bản
                const hasJsonStructure = trimmed.includes(':') || 
                                        (trimmed.startsWith('[') && trimmed.includes(','));
                
                if (!hasJsonStructure) return;
                
                // Đếm số dòng
                const lineCount = countLines(plainText);
                
                // Tạo wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'json-display-wrapper';
                
                // Tạo controls bar
                const controls = document.createElement('div');
                controls.className = 'json-controls';
                
                // Nút Copy
                const copyBtn = document.createElement('button');
                copyBtn.className = 'json-copy-btn';
                copyBtn.innerHTML = copyIconSvg + '<span>Copy JSON</span>';
                copyBtn.type = 'button';
                copyBtn.addEventListener('click', async function() {
                    const success = await copyToClipboard(plainText);
                    if (success) {
                        copyBtn.classList.add('copied');
                        copyBtn.innerHTML = checkIconSvg + '<span>Copied!</span>';
                        setTimeout(() => {
                            copyBtn.classList.remove('copied');
                            copyBtn.innerHTML = copyIconSvg + '<span>Copy JSON</span>';
                        }, 2000);
                    }
                });
                
                // Toggle Wrap button
                const wrapToggle = document.createElement('button');
                wrapToggle.className = 'json-wrap-toggle';
                wrapToggle.textContent = 'Wrap Lines';
                wrapToggle.type = 'button';
                wrapToggle.addEventListener('click', function() {
                    wrapper.classList.toggle('wrap-mode');
                    wrapToggle.classList.toggle('active');
                    wrapToggle.textContent = wrapper.classList.contains('wrap-mode') 
                        ? 'No Wrap' 
                        : 'Wrap Lines';
                });
                
                controls.appendChild(copyBtn);
                controls.appendChild(wrapToggle);
                
                // Tạo container với line numbers
                const jsonContainer = document.createElement('div');
                jsonContainer.className = 'json-with-lines';
                
                // Line numbers (chỉ hiển thị nếu có nhiều hơn 1 dòng)
                if (lineCount > 1) {
                    const lineNumbers = document.createElement('div');
                    lineNumbers.className = 'json-line-numbers';
                    lineNumbers.textContent = createLineNumbers(lineCount);
                    jsonContainer.appendChild(lineNumbers);
                }
                
                // Code content area
                const codeContent = document.createElement('div');
                codeContent.className = 'json-code-content';
                
                // Di chuyển pre element vào codeContent (không clone, move trực tiếp để giữ nguyên mọi thứ)
                // Clone trước để giữ nguyên trong DOM gốc nếu cần
                const preElement = preCodeBlock.cloneNode(true);
                
                // Đảm bảo pre element giữ nguyên styles và attributes
                preElement.style.margin = '0';
                preElement.style.padding = '0';
                preElement.style.background = 'transparent';
                
                codeContent.appendChild(preElement);
                jsonContainer.appendChild(codeContent);
                
                // Assemble
                wrapper.appendChild(controls);
                wrapper.appendChild(jsonContainer);
                
                // Thay thế preCodeBlock bằng wrapper
                // Đảm bảo parent node tồn tại
                if (preCodeBlock.parentNode) {
                    preCodeBlock.parentNode.replaceChild(wrapper, preCodeBlock);
                } else {
                    console.warn('Cannot replace: preCodeBlock has no parent node');
                    return;
                }
                
                // Đảm bảo content hiển thị sau khi replace
                setTimeout(() => {
                    const codeEl = codeContent.querySelector('code');
                    if (codeEl && codeEl.textContent.trim().length === 0) {
                        console.warn('Warning: Code element appears empty after enhancement');
                    }
                }, 100);
            }
            
            // Hàm tìm và enhance tất cả JSON blocks
            function enhanceAllJsonDisplays() {
                // Chỉ tìm trong response body areas, tránh request examples
                const responseSelectors = [
                    '[class*="response"] pre code',
                    '[class*="Response"] pre code',
                    '[id*="response"] pre code',
                    '[id*="Response"] pre code',
                    'pre code.hljs',
                    'pre code[class*="hljs"]',
                    'pre code[class*="language-json"]'
                ];
                
                let found = false;
                const processed = new Set(); // Track processed elements để tránh duplicate
                
                responseSelectors.forEach(selector => {
                    try {
                        const codeBlocks = document.querySelectorAll(selector);
                        codeBlocks.forEach(codeBlock => {
                            // Skip nếu đã được xử lý
                            if (processed.has(codeBlock)) return;
                            
                            // Chỉ xử lý nếu trong response area, không phải request
                            const isInResponse = codeBlock.closest('[class*="response"], [class*="Response"], [id*="response"], [id*="Response"]');
                            const isInRequest = codeBlock.closest('[class*="request"], [class*="Request"], [class*="example"], [class*="Example"], [class*="curl"], [class*="Curl"]');
                            
                            if (isInResponse && !isInRequest) {
                                const preBlock = codeBlock.closest('pre');
                                if (preBlock && !preBlock.closest('.json-display-wrapper')) {
                                    processed.add(codeBlock);
                                    enhanceJsonDisplay(preBlock);
                                    found = true;
                                }
                            }
                        });
                    } catch (e) {
                        console.warn('Error processing selector:', selector, e);
                    }
                });
                
                return found;
            }
            
            // Observer để tự động enhance khi có content mới
            let observer = null;
            
            function setupObserver() {
                if (observer) {
                    observer.disconnect();
                }
                
                observer = new MutationObserver(function(mutations) {
                    let shouldEnhance = false;
                    mutations.forEach(mutation => {
                        if (mutation.addedNodes.length > 0) {
                            shouldEnhance = true;
                        }
                    });
                    
                    if (shouldEnhance) {
                        // Debounce: đợi một chút để Scalar render xong
                        setTimeout(() => {
                            enhanceAllJsonDisplays();
                        }, 500);
                    }
                });
                
                // Observe toàn bộ document
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }
            
            // Khởi tạo
            function initJsonEnhancement() {
                console.log('[JSON Enhancement] Initializing...');
                
                // Enhance ngay lập tức
                const found = enhanceAllJsonDisplays();
                console.log('[JSON Enhancement] Initial enhancement:', found ? 'found JSON blocks' : 'no JSON blocks found');
                
                // Setup observer
                setupObserver();
                
                // Enhance lại sau khi Scalar load xong (nếu có)
                if (typeof window.scalarInstance !== 'undefined') {
                    setTimeout(() => {
                        console.log('[JSON Enhancement] Re-enhancing after Scalar load...');
                        enhanceAllJsonDisplays();
                    }, 2000);
                }
            }
            
            // Chạy khi DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initJsonEnhancement, 500);
                });
            } else {
                setTimeout(initJsonEnhancement, 500);
            }
            
            // Chạy lại sau khi window load (để bắt Scalar content)
            window.addEventListener('load', function() {
                setTimeout(function() {
                    console.log('[JSON Enhancement] Re-enhancing after window load...');
                    initJsonEnhancement();
                }, 1500);
            });
            
            // Expose function để có thể gọi thủ công nếu cần
            window.enhanceJsonDisplays = function() {
                console.log('[JSON Enhancement] Manual trigger');
                return enhanceAllJsonDisplays();
            };
        })();
    </script>
</body>
</html>
